<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Wordiness Lab â€” Shapes &amp; Sounds</title>
    <style>
      /* Basic reset and typography */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        background: #0c1e32;
        color: #e6f3ff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      h1,
      h2,
      h3 {
        margin: 0.5em 0;
        color: #ffee88;
      }
      p {
        margin: 0.5em 0 1em;
        line-height: 1.4;
      }

      /* Crest image container */
      #crestContainer {
        width: 100px;
        height: 100px;
        margin-top: 1em;
        margin-bottom: 1em;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 50%;
      }

      /* Voice picker */
      #voicePicker {
        margin-bottom: 1em;
        text-align: center;
      }
      #voiceSelect {
        padding: 0.25em;
        font-size: 1em;
      }

      /* Tab navigation */
      .tab-buttons {
        display: flex;
        gap: 0.5em;
        margin-bottom: 1em;
        flex-wrap: wrap;
        justify-content: center;
      }
      .tab-buttons button {
        padding: 0.5em 1em;
        background: #173d65;
        border: 2px solid #2b5a88;
        border-radius: 0.75em;
        color: #e6f3ff;
        cursor: pointer;
        transition: background 0.2s;
      }
      .tab-buttons button.active,
      .tab-buttons button:hover {
        background: #2b5a88;
      }

      /* Section styles */
      .section {
        display: none;
        max-width: 800px;
        width: 100%;
        padding: 1em;
        border: 2px solid #173d65;
        border-radius: 0.75em;
        background: #102642;
      }
      .section.active {
        display: block;
      }

      /* Syllable Shuffle */
      #syllableDisplay {
        display: flex;
        align-items: center;
        gap: 1em;
        flex-wrap: wrap;
      }
      #buildZone {
        display: flex;
        gap: 0.5em;
        flex-wrap: wrap;
        border: 2px dashed #2b5a88;
        padding: 0.5em;
        min-height: 50px;
        border-radius: 0.5em;
        margin-bottom: 1em;
      }
      .drop-placeholder {
        width: auto;
        min-width: 40px;
        padding: 0.5em;
        border: 2px solid #2b5a88;
        border-radius: 0.5em;
        text-align: center;
        margin: 0.25em;
        background: #173d65;
        color: #e6f3ff;
        font-weight: bold;
      }
      .tile {
        display: inline-block;
        padding: 0.5em 0.75em;
        margin: 0.25em;
        border-radius: 0.5em;
        background: #275f8f;
        border: 2px solid #2b5a88;
        color: #e6f3ff;
        cursor: grab;
        user-select: none;
      }
      .tile:active {
        cursor: grabbing;
      }

      /* Rhyme Radar */
      #rhymeBins {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-bottom: 1em;
      }
      .rhyme-bin {
        flex: 1 1 45%;
        border: 2px dashed #2b5a88;
        padding: 0.5em;
        min-height: 100px;
        border-radius: 0.5em;
        position: relative;
      }
      .rhyme-bin h4 {
        margin-top: 0;
        margin-bottom: 0.5em;
        color: #ffee88;
      }
      #rhymeWords {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
      }
      .rhyme-word {
        padding: 0.5em 0.75em;
        border: 2px solid #2b5a88;
        border-radius: 0.5em;
        background: #275f8f;
        color: #e6f3ff;
        cursor: grab;
      }

      /* Sound Shapes */
      #letterBag {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
        margin-bottom: 1em;
      }
      .letter-tile {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #2b5a88;
        border-radius: 50%;
        background: #275f8f;
        color: #e6f3ff;
        font-weight: bold;
        cursor: grab;
      }
      #shapeZone {
        border: 2px dashed #2b5a88;
        padding: 1em;
        min-height: 120px;
        border-radius: 0.5em;
        margin-bottom: 1em;
        position: relative;
      }
      .shape-letter {
        position: absolute;
        font-size: 24px;
        color: #ffee88;
        cursor: move;
      }
      #soundGraph {
        height: 100px;
        width: 100%;
        background: #173d65;
        border-radius: 0.5em;
        display: flex;
        align-items: flex-end;
        gap: 0.5em;
        padding: 0.5em;
        margin-bottom: 1em;
      }
      .bar {
        flex: 1;
        background: #2b5a88;
        border: 2px solid #275f8f;
        border-radius: 0.25em;
        position: relative;
      }
      .bar-label {
        position: absolute;
        top: -1.5em;
        width: 100%;
        text-align: center;
        color: #ffee88;
      }

      /* Teacher key */
      #teacherSection {
        max-height: 300px;
        overflow-y: auto;
      }
      details {
        margin-bottom: 0.5em;
        background: #173d65;
        border: 2px solid #2b5a88;
        border-radius: 0.5em;
        padding: 0.5em;
      }
      summary {
        cursor: pointer;
        font-weight: bold;
        color: #ffee88;
      }

      /* Buttons */
      button {
        font-size: 1em;
      }
    </style>
  <style>
/* wordiness-ui-polish-v4 */
:root{
  --tapMin: 44px;
  --safeBottom: env(safe-area-inset-bottom, 0px);
}
html, body{ height: 100%; }
body{
  min-height: 100dvh;
  padding-bottom: var(--safeBottom);
  -webkit-text-size-adjust: 100%;
  overscroll-behavior: contain;
}
@supports (height: 100svh){ body{ min-height: 100svh; } }

*{ -webkit-tap-highlight-color: transparent; }

button, [role="button"], a, input, select, textarea,
.tile, .wordCard, .slot, .badge{
  min-height: var(--tapMin);
}

button, [role="button"], a, .tile, .wordCard, .slot{
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
}

input, textarea, select{
  font-size: 16px !important; /* prevent iOS zoom */
}

[draggable="true"], .wordiness-draggable{
  touch-action: none; /* reduce scroll-vs-drag fighting */
}

.wordiness-drag-selected{
  outline: 3px solid rgba(56,189,248,.55) !important;
}

@media (prefers-reduced-motion: reduce){
  *{ scroll-behavior: auto !important; transition: none !important; animation: none !important; }
}
</style>
</head>
  <body>
    <div id="crestContainer"></div>
    <h1>Wordiness Lab â€” Shapes &amp; Sounds</h1>
    <p>
      Welcome to the Wordiness Lab! This playful language centre helps you explore
      the shapes and sounds of words. Choose a tab to begin.
    </p>
    <!-- Voice picker -->
    <div id="voicePicker">
      <label for="voiceSelect">Select voice for speech:</label>
      <select id="voiceSelect"></select>
    </div>
    <!-- Tab navigation -->
    <nav class="tab-buttons">
      <button class="active" data-tab="syllable">Syllable Shuffle</button>
      <button data-tab="rhyme">Rhyme Radar</button>
      <button data-tab="sound">Sound Shapes</button>
      <button data-tab="teacher">Teacher Key</button>
    </nav>
    <!-- Syllable Shuffle Section -->
    <section id="syllable" class="section active">
      <h2>Syllable Shuffle</h2>
      <p>
        Drag the syllable tiles into the build box to assemble the word. When
        you're finished, the box will turn green if you built the word
        correctly.
      </p>
      <div id="syllableDisplay">
        <h3 id="currentWordTitle">Build:</h3>
        <button id="newWordBtn">New word</button>
        <button id="hearWordBtn">Hear word</button>
      </div>
      <div id="buildZone"></div>
      <div id="tilesContainer"></div>
    </section>
    <!-- Rhyme Radar Section -->
    <section id="rhyme" class="section">
      <h2>Rhyme Radar</h2>
      <p>
        Sort each word into the correct rhyme bin. Drag a word onto a bin to see
        if it belongs there. Correct matches stick; incorrect words bounce
        back.
      </p>
      <div id="rhymeBins"></div>
      <div id="rhymeWords"></div>
    </section>
    <!-- Sound Shapes Section -->
    <section id="sound" class="section">
      <h2>Sound Shapes</h2>
      <p>
        Build a word by dragging letters onto the board. Listen to each letter
        as you place it and watch the vowel vs. consonant graph grow.
      </p>
      <div id="letterBag"></div>
      <div id="shapeZone"></div>
      <div id="soundGraph"></div>
    </section>
    <!-- Teacher Key Section -->
    <section id="teacher" class="section" aria-labelledby="teacherHeading">
      <h2 id="teacherHeading">Teacher Key</h2>
      <p>
        This section lists the syllable breakdowns and rhyme assignments used
        throughout the activities. Expand each item to see details. This is
        hidden from students by default.
      </p>
      <div id="teacherSection"></div>
    </section>
    <script>
      // Preload crest if available
      (function () {
        const crest = new Image();
        crest.src = '/wordiness/crest.png';
        crest.onload = () => {
          document.getElementById('crestContainer').style.backgroundImage =
            'url(' + crest.src + ')';
        };
      })();

      // Speech synthesis setup
      const synth = window.speechSynthesis;
      const voiceSelect = document.getElementById('voiceSelect');
      function populateVoices() {
        const voices = synth.getVoices();
        voiceSelect.innerHTML = '';
        voices.forEach((voice, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = voice.name + (voice.lang ? ' (' + voice.lang + ')' : '');
          voiceSelect.appendChild(option);
        });
      }
      populateVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoices;
      }
      function speak(text) {
        if (!text) return;
        const utter = new SpeechSynthesisUtterance(text);
        const voices = synth.getVoices();
        const selected = voices[voiceSelect.value] || voices[0];
        utter.voice = selected;
        try{synth.cancel();}catch(e){}
        setTimeout(() => { try{synth.speak(utter);}catch(e){} }, 60);
      }

      // Tab navigation logic
      document.querySelectorAll('.tab-buttons button').forEach((btn) => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-buttons button').forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.section').forEach((sec) => sec.classList.remove('active'));
          const tabId = btn.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
        });
      });

      // Words for syllable shuffle (could be expanded)
      const wordList = [
        'healthy',
        'eating',
        'energy',
        'variety',
        'protein',
        'balanced',
        'vitamins',
        'minerals',
        'dairy',
        'fruits',
        'vegetables',
        'grains',
        'hydration',
        'snacks',
        'nutrients',
        'growth',
        'family',
      ];

      // Heuristic syllable splitter
      function splitIntoSyllables(word) {
        const vowels = 'aeiouyAEIOUY';
        const segments = [];
        let segStart = 0;
        let i = 0;
        while (i < word.length) {
          if (vowels.includes(word[i])) {
            let j = i;
            while (j + 1 < word.length && vowels.includes(word[j + 1])) {
              j++;
            }
            const nextPos = j + 1;
            if (nextPos < word.length - 1) {
              segments.push(word.slice(segStart, nextPos));
              segStart = nextPos;
            }
            i = j;
          }
          i++;
        }
        if (segStart < word.length) {
          segments.push(word.slice(segStart));
        }
        return segments;
      }

      // Syllable shuffle game
      const buildZone = document.getElementById('buildZone');
      const tilesContainer = document.getElementById('tilesContainer');
      const currentWordTitle = document.getElementById('currentWordTitle');
      let currentWord = '';
      let currentSyllables = [];
      function newWord() {
        currentWord = wordList[Math.floor(Math.random() * wordList.length)];
        currentSyllables = splitIntoSyllables(currentWord);
        currentWordTitle.textContent = 'Build: ' + currentWord;
        buildZone.innerHTML = '';
        tilesContainer.innerHTML = '';
        // create drop placeholders
        currentSyllables.forEach(() => {
          const placeholder = document.createElement('div');
          placeholder.className = 'drop-placeholder';
          placeholder.dataset.filled = 'false';
          buildZone.appendChild(placeholder);
        });
        // create tiles in random order
        const shuffled = currentSyllables
          .map((s) => ({ s, r: Math.random() }))
          .sort((a, b) => a.r - b.r)
          .map((obj) => obj.s);
        shuffled.forEach((syl) => {
          const tile = document.createElement('div');
          tile.className = 'tile';
          tile.textContent = syl;
          tile.draggable = true;
          tile.dataset.syllable = syl;
          tile.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', syl);
          });
          tilesContainer.appendChild(tile);
        });
        buildZone.style.backgroundColor = '';
      }

      buildZone.addEventListener('dragover', (e) => {
        e.preventDefault();
      });
      buildZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const syl = e.dataTransfer.getData('text/plain');
        // find the first unfilled placeholder
        const placeholder = [...buildZone.children].find((d) => d.dataset.filled === 'false');
        if (!placeholder) return;
        const tile = [...tilesContainer.children].find((t) => t.dataset.syllable === syl);
        if (tile) {
          placeholder.textContent = syl;
          placeholder.dataset.filled = 'true';
          tile.remove();
          checkBuild();
        }
      });
      function checkBuild() {
        const assembled = [...buildZone.children]
          .map((d) => d.textContent.trim())
          .join('');
        if (assembled.toLowerCase() === currentWord.toLowerCase()) {
          buildZone.style.backgroundColor = '#264d27';
        }
      }
      document.getElementById('newWordBtn').addEventListener('click', newWord);
      document.getElementById('hearWordBtn').addEventListener('click', () => {
        speak(currentWord);
      });
      // initialise first word
      newWord();

      // Rhyme radar data
      const rhymeGroups = [
        {
          label: 'ate',
          words: ['late', 'gate', 'plate', 'date'],
        },
        {
          label: 'all',
          words: ['ball', 'call', 'hall', 'tall'],
        },
        {
          label: 'ight',
          words: ['light', 'night', 'flight', 'bright'],
        },
        {
          label: 'ook',
          words: ['book', 'hook', 'cook', 'nook'],
        },
        {
          label: 'air',
          words: ['chair', 'pair', 'fair', 'stair'],
        },
      ];
      // build bins and words
      const rhymeBins = document.getElementById('rhymeBins');
      const rhymeWordsContainer = document.getElementById('rhymeWords');
      function setupRhymes() {
        rhymeBins.innerHTML = '';
        rhymeWordsContainer.innerHTML = '';
        const allWords = [];
        rhymeGroups.forEach((group, groupIndex) => {
          const bin = document.createElement('div');
          bin.className = 'rhyme-bin';
          bin.dataset.group = group.label;
          const heading = document.createElement('h4');
          heading.textContent = 'Rhymes with ' + group.words[0];
          bin.appendChild(heading);
          bin.addEventListener('dragover', (e) => {
            e.preventDefault();
          });
          bin.addEventListener('drop', (e) => {
            e.preventDefault();
            const word = e.dataTransfer.getData('text/plain');
            const sourceElem = [...rhymeWordsContainer.children].find((w) => w.textContent === word);
            if (!sourceElem) return;
            const belongs = rhymeGroups
              .find((g) => g.label === bin.dataset.group)
              .words.includes(word);
            if (belongs) {
              // correct: stick inside bin
              const placed = document.createElement('div');
              placed.textContent = word;
              placed.className = 'rhyme-word';
              placed.style.background = '#264d27';
              bin.appendChild(placed);
              sourceElem.remove();
            } else {
              // bounce back: shake effect
              sourceElem.classList.add('shake');
              setTimeout(() => sourceElem.classList.remove('shake'), 500);
            }
          });
          rhymeBins.appendChild(bin);
          allWords.push(...group.words);
        });
        // shuffle all words
        const shuffledWords = allWords
          .map((w) => ({ w, r: Math.random() }))
          .sort((a, b) => a.r - b.r)
          .map((obj) => obj.w);
        shuffledWords.forEach((word) => {
          const w = document.createElement('div');
          w.className = 'rhyme-word';
          w.textContent = word;
          w.draggable = true;
          w.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', word);
          });
          rhymeWordsContainer.appendChild(w);
        });
      }
      setupRhymes();

      // Sound Shapes
      const vowels = 'aeiouy';
      const letterBag = document.getElementById('letterBag');
      const shapeZone = document.getElementById('shapeZone');
      const soundGraph = document.getElementById('soundGraph');
      // create bars for vowels vs consonants
      const vowelBar = document.createElement('div');
      vowelBar.className = 'bar';
      const vowelLabel = document.createElement('div');
      vowelLabel.className = 'bar-label';
      vowelLabel.textContent = 'Vowels';
      vowelBar.appendChild(vowelLabel);
      const consonantBar = document.createElement('div');
      consonantBar.className = 'bar';
      const consonantLabel = document.createElement('div');
      consonantLabel.className = 'bar-label';
      consonantLabel.textContent = 'Consonants';
      consonantBar.appendChild(consonantLabel);
      soundGraph.appendChild(vowelBar);
      soundGraph.appendChild(consonantBar);
      function updateGraph() {
        const letters = [...shapeZone.querySelectorAll('.shape-letter')].map((el) => el.textContent);
        const vowelCount = letters.filter((ch) => vowels.includes(ch.toLowerCase())).length;
        const consonantCount = letters.length - vowelCount;
        // avoid NaN for empty
        const total = Math.max(letters.length, 1);
        vowelBar.style.height = ((vowelCount / total) * 100).toFixed(0) + '%';
        consonantBar.style.height = ((consonantCount / total) * 100).toFixed(0) + '%';
      }
      // generate letter tiles
      const alphabet = 'abcdefghijklmnopqrstuvwxyz'.split('');
      alphabet.forEach((ch) => {
        const tile = document.createElement('div');
        tile.className = 'letter-tile';
        tile.textContent = ch;
        tile.draggable = true;
        tile.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', ch);
        });
        letterBag.appendChild(tile);
      });
      // handle drops on shape zone
      shapeZone.addEventListener('dragover', (e) => {
        e.preventDefault();
      });
      shapeZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const ch = e.dataTransfer.getData('text/plain');
        if (!ch) return;
        const letterEl = document.createElement('div');
        letterEl.className = 'shape-letter';
        letterEl.textContent = ch;
        // position relative to drop
        const rect = shapeZone.getBoundingClientRect();
        letterEl.style.left = e.clientX - rect.left - 12 + 'px';
        letterEl.style.top = e.clientY - rect.top - 12 + 'px';
        // speak letter
        speak(ch);
        shapeZone.appendChild(letterEl);
        updateGraph();
        // allow dragging of placed letters within the zone
        letterEl.addEventListener('mousedown', function (ev) {
          ev.preventDefault();
          let shiftX = ev.clientX - letterEl.getBoundingClientRect().left;
          let shiftY = ev.clientY - letterEl.getBoundingClientRect().top;
          function onMouseMove(moveEvent) {
            letterEl.style.left = moveEvent.clientX - rect.left - shiftX + 'px';
            letterEl.style.top = moveEvent.clientY - rect.top - shiftY + 'px';
          }
          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          }
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });

      // Teacher key generation
      const teacherSection = document.getElementById('teacherSection');
      function populateTeacherKey() {
        teacherSection.innerHTML = '';
        const syllableList = document.createElement('details');
        const sum1 = document.createElement('summary');
        sum1.textContent = 'Syllable breakdowns';
        syllableList.appendChild(sum1);
        const ul1 = document.createElement('ul');
        ul1.style.listStyleType = 'none';
        ul1.style.paddingLeft = '0';
        wordList.forEach((word) => {
          const li = document.createElement('li');
          li.textContent = word + ' â†’ ' + splitIntoSyllables(word).join(' | ');
          ul1.appendChild(li);
        });
        syllableList.appendChild(ul1);
        teacherSection.appendChild(syllableList);
        // rhyme assignments
        const rhymeList = document.createElement('details');
        const sum2 = document.createElement('summary');
        sum2.textContent = 'Rhyme groups';
        rhymeList.appendChild(sum2);
        const ul2 = document.createElement('ul');
        ul2.style.listStyleType = 'none';
        ul2.style.paddingLeft = '0';
        rhymeGroups.forEach((g) => {
          const li = document.createElement('li');
          li.textContent = g.label + ' â†’ ' + g.words.join(', ');
          ul2.appendChild(li);
        });
        rhymeList.appendChild(ul2);
        teacherSection.appendChild(rhymeList);
      }
      populateTeacherKey();
    </script>
  <!-- WORDINESS_FAILSAFE_PATCH v1 -->
<script id="wordiness-failsafe-patch">
(function(){
  if (window.__wordinessFailsafePatch) return;
  window.__wordinessFailsafePatch = true;

  const VOWEL = /[aeiouy]/i;

  const EXCEPTIONS = {
    different:   { spelling:["dif","fer","ent"], spoken:[["dif","frent"],["dif","rent"]] },
    vegetable:   { spelling:["ve","ge","ta","ble"], spoken:[["veg","ta","ble"],["vej","ta","bul"]] },
    factory:     { spelling:["fac","to","ry"], spoken:[["fac","tuh","ree"],["fac","tri"]] },
    family:      { spelling:["fam","i","ly"], spoken:[["fam","ly"]] },
    chocolate:   { spelling:["choc","o","late"], spoken:[["choc","late"]] },
    camera:      { spelling:["cam","er","a"], spoken:[["cam","ra"]] },
    interesting: { spelling:["in","ter","est","ing"], spoken:[["in","tres","ting"]] },
    probably:    { spelling:["prob","a","bly"], spoken:[["prob","ly"]] }
  };

  function hasVowelLetters(s){ return VOWEL.test(String(s||"")); }
  function lettersSpaced(s){ return String(s||"").split("").join(" "); }
  function onlyLetters(s){ return String(s||"").toLowerCase().replace(/[^a-z']/g,""); }

  function normalizeLine(s){
    return String(s||"")
      .replace(/[\u2010\u2011\u2012\u2013\u2014\u2212]/g, "-") // fancy dashes
      .replace(/\u00B7/g, "·") // middle dot
      .trim();
  }

  // Extract sensible words from pasted text, but preserve already-marked syllable lines
  function sanitizeSeedText(raw){
    raw = String(raw||"").replace(/\r/g,"");
    const out = [];
    for (const line0 of raw.split("\n")) {
      const line = normalizeLine(line0);
      if (!line) continue;

      // Keep marked syllable lines like dif-fer-ent (no spaces)
      if (/[-·]/.test(line) && !/\s/.test(line)) {
        out.push(line);
        continue;
      }

      // Otherwise extract word tokens from the line
      const toks = line.match(/[A-Za-z]+(?:'[A-Za-z]+)?/g);
      if (!toks) continue;
      for (const w of toks) {
        if (w.length > 28) continue;
        if (!hasVowelLetters(w)) continue;
        out.push(w);
      }
    }

    // de-dupe, preserve order
    const seen = new Set();
    const final = [];
    for (const w of out) {
      const k = w.toLowerCase();
      if (seen.has(k)) continue;
      seen.add(k);
      final.push(w);
    }
    return final.join("\n");
  }

  // Replace a specific line (by index) with chunked form, joined by '-'
  function replaceLine(text, lineIndex, newChunks){
    const lines = String(text||"").replace(/\r/g,"").split("\n");
    if (lineIndex < 0 || lineIndex >= lines.length) return text;
    lines[lineIndex] = newChunks.join("-");
    return lines.join("\n");
  }

  // Find a textarea likely used for word lists
  function findSeedTextarea(){
    return document.querySelector("textarea#input, textarea#seed, textarea[data-seed], textarea");
  }

  // Build helper UI under textarea: reduction suggestions + failsafe warnings + sanitize button
  function attachHelperUI(ta){
    if (!ta || ta.__wordinessHelperAttached) return;
    ta.__wordinessHelperAttached = true;

    const host = document.createElement("div");
    host.style.cssText = [
      "margin-top:10px",
      "border:1px solid rgba(255,255,255,.14)",
      "border-radius:14px",
      "padding:10px 12px",
      "background:rgba(0,0,0,.10)",
      "color:rgba(238,242,255,.85)",
      "font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial",
      "font-size:13px"
    ].join(";");

    const hdr = document.createElement("div");
    hdr.style.cssText = "display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;";
    hdr.innerHTML = `<b>Wordiness helpers</b>
      <span style="opacity:.8">failsafes + disappearing-vowel options</span>`;
    host.appendChild(hdr);

    const btnRow = document.createElement("div");
    btnRow.style.cssText = "display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;";
    const sanitizeBtn = document.createElement("button");
    sanitizeBtn.type = "button";
    sanitizeBtn.textContent = "Sanitize pasted text → words";
    sanitizeBtn.style.cssText =
      "cursor:pointer;border-radius:999px;padding:8px 10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);color:rgba(238,242,255,.92);font-weight:700;";
    btnRow.appendChild(sanitizeBtn);
    host.appendChild(btnRow);

    const msg = document.createElement("div");
    msg.style.cssText = "margin-top:10px;opacity:.9;";
    host.appendChild(msg);

    const sug = document.createElement("div");
    sug.style.cssText = "display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;";
    host.appendChild(sug);

    function refresh(){
      const raw = String(ta.value||"");
      const lines = raw.replace(/\r/g,"").split("\n").map(normalizeLine);
      sug.innerHTML = "";

      // Warnings: chunks with no vowel letters (only checks marked chunk lines)
      let warnCount = 0;
      for (const ln of lines) {
        if (!ln) continue;
        if (/[-·]/.test(ln) && !/\s/.test(ln)) {
          const parts = ln.split(/[-·]+/).map(s=>s.trim()).filter(Boolean);
          const bad = parts.filter(p=>!hasVowelLetters(p));
          if (bad.length) warnCount++;
        }
      }

      // Suggestions for disappearing vowels
      const found = [];
      lines.forEach((ln, i)=>{
        if (!ln) return;
        const key = onlyLetters(ln.replace(/[-·]/g,""));
        if (EXCEPTIONS[key]) found.push({ key, i });
      });

      msg.innerHTML =
        `${warnCount ? `<span style="color:#f59e0b;font-weight:800">${warnCount} warning(s)</span> (chunk has no vowel letters). ` : `<span style="color:#22c55e;font-weight:800">No failsafe warnings</span>. `}
         ${found.length ? `Found <b>${found.length}</b> reduction word(s).` : `No reduction words detected in list.`}`;

      // Make buttons for each found word
      found.slice(0, 12).forEach(({key, i})=>{
        const ex = EXCEPTIONS[key];
        const label = key;
        const makeBtn = (text, chunks) => {
          const b = document.createElement("button");
          b.type = "button";
          b.textContent = `${label}: ${text}`;
          b.style.cssText =
            "cursor:pointer;border-radius:999px;padding:8px 10px;border:1px solid rgba(56,189,248,.28);background:rgba(56,189,248,.08);color:rgba(238,242,255,.92);font-weight:800;";
          b.onclick = ()=>{
            ta.value = replaceLine(ta.value, i, chunks);
            ta.dispatchEvent(new Event("input", { bubbles:true }));
          };
          return b;
        };

        if (ex.spelling) sug.appendChild(makeBtn("Use spelling", ex.spelling));
        if (Array.isArray(ex.spoken)) {
          ex.spoken.forEach(opt => sug.appendChild(makeBtn("Use spoken", opt)));
        }
      });
    }

    sanitizeBtn.onclick = ()=>{
      const before = ta.value;
      const after = sanitizeSeedText(before);
      if (after && after !== before) {
        ta.value = after;
        ta.dispatchEvent(new Event("input", { bubbles:true }));
      }
    };

    // Insert right after textarea
    ta.insertAdjacentElement("afterend", host);

    // Live update
    let t = null;
    ta.addEventListener("input", ()=>{
      clearTimeout(t);
      t = setTimeout(refresh, 120);
    });
    refresh();
  }

  // TTS fail-safe wrapper: if no vowel letters and short, speak letters spaced
  function wrapSpeak(fnName){
    const old = window[fnName];
    if (typeof old !== "function") return;
    if (old.__wordinessWrapped) return;

    function wrapped(text, ...rest){
      const t = String(text||"").trim();
      if (t && !hasVowelLetters(t) && t.length <= 8) {
        return old.call(this, lettersSpaced(t), ...rest);
      }
      return old.call(this, text, ...rest);
    }
    wrapped.__wordinessWrapped = true;
    window[fnName] = wrapped;
  }

  // Try common TTS function names used across your games
  ["speakNow","speak","speakText","say"].forEach(wrapSpeak);

  // Seed sanitiser if game uses #seed=
  function patchSeedFromHash(){
    const h = String(location.hash||"");
    if (!/seed=/.test(h)) return;
    const ta = findSeedTextarea();
    if (!ta) return;
    const before = ta.value;
    const after = sanitizeSeedText(before);
    if (after && after !== before) {
      ta.value = after;
      ta.dispatchEvent(new Event("input", { bubbles:true }));
    }
  }

  // Attach helpers on load
  function boot(){
    const ta = findSeedTextarea();
    if (ta) attachHelperUI(ta);
    patchSeedFromHash();
  }

  window.addEventListener("hashchange", ()=>setTimeout(patchSeedFromHash, 0));
  setTimeout(boot, 80);

})();
</script>
<!-- /WORDINESS_FAILSAFE_PATCH v1 -->
<script>
// wordiness-touch-helpers-v4
(function(){
  try{
    var isCoarse=false;
    try{ isCoarse = window.matchMedia && window.matchMedia("(pointer: coarse)").matches; }catch(e){}
    var isTouch = isCoarse || ("ontouchstart" in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints>0);

    // Crest fallback (works for /wordiness and file:// exports)
    var crest = document.getElementById("crest");
    if (crest && crest.tagName === "IMG") {
      crest.addEventListener("error", function(){ crest.src="/wordiness/crest.png"; }, { once:true });
    }

    if(!isTouch) return;

    var drags = Array.prototype.slice.call(document.querySelectorAll('[draggable="true"]'));
    if(!drags.length) return;

    drags.forEach(function(el){
      el.classList.add("wordiness-draggable");
      el.addEventListener("click", function(){
        drags.forEach(function(x){ x.classList.remove("wordiness-drag-selected"); });
        el.classList.add("wordiness-drag-selected");
      }, { passive:true });
    });

    var btn = document.createElement("button");
    btn.id="wordinessTouchToggle";
    btn.type="button";
    btn.style.position="fixed";
    btn.style.right="12px";
    btn.style.bottom="calc(12px + env(safe-area-inset-bottom, 0px))";
    btn.style.zIndex="9999";
    btn.style.border="1px solid rgba(255,255,255,.18)";
    btn.style.background="rgba(0,0,0,.45)";
    btn.style.color="rgba(238,242,255,.95)";
    btn.style.backdropFilter="blur(10px)";
    btn.style.borderRadius="999px";
    btn.style.padding="10px 12px";
    btn.style.font="600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    btn.style.touchAction="manipulation";

    var dragEnabled=true;
    function applyState(){
      drags.forEach(function(el){ el.setAttribute("draggable", dragEnabled ? "true" : "false"); });
      btn.textContent = dragEnabled ? "Touch: Drag ON" : "Touch: Drag OFF";
    }
    btn.addEventListener("click", function(){ dragEnabled=!dragEnabled; applyState(); });

    document.body.appendChild(btn);
    applyState();
  }catch(e){}
})();
</script>
</body>
</html>