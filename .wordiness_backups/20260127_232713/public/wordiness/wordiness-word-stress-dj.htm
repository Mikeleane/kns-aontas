<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wordiness — Word Stress DJ</title>
<style>
  :root{
    --text:#eef2ff; --muted:rgba(238,242,255,.72); --line:rgba(238,242,255,.16);
    --ok:#22c55e; --no:#ef4444; --acc:#38bdf8; --warn:#f59e0b;
    --r:18px; --base:18px; --lh:1.7; --ls:0px; --ws:0px;
    --panelA: rgba(16,27,51,.78);
    --panelB: rgba(11,20,40,.72);
  }
  body.supported{ --base:19px; --lh:1.9; --ls:.2px; --ws:.7px; }
  body.reduceMotion *{ transition:none !important; animation:none !important; scroll-behavior:auto !important; }

  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    font-size:var(--base); line-height:var(--lh); letter-spacing:var(--ls); word-spacing:var(--ws);
    background:
      radial-gradient(900px 500px at 15% -10%, rgba(56,189,248,.14), transparent 60%),
      radial-gradient(900px 500px at 92% 10%, rgba(34,197,94,.12), transparent 55%),
      linear-gradient(180deg,#050816,#070b16 55%,#050816);
  }

  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{
    position:sticky; top:10px; z-index:10;
    backdrop-filter: blur(10px);
    border:1px solid var(--line); border-radius:var(--r);
    background:linear-gradient(180deg, rgba(16,27,51,.88), rgba(11,20,40,.78));
    padding:12px 14px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  }
  h1{margin:0;font-size:18px}
  .sub{margin-top:2px;color:var(--muted);font-size:13px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,button,input{font:inherit}
  select, input[type="range"]{
    background:rgba(0,0,0,.25); color:var(--text);
    border:1px solid var(--line); padding:8px 10px; border-radius:12px; outline:none;
  }
  input[type="range"]{ padding:0; height:36px; }
  button{
    cursor:pointer; border-radius:12px; padding:10px 12px; color:var(--text);
    border:1px solid rgba(34,197,94,.35);
    background:linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.08));
  }
  button.ghost{border:1px solid var(--line); background:rgba(255,255,255,.04)}
  button.bad{border:1px solid rgba(239,68,68,.35); background:linear-gradient(180deg, rgba(239,68,68,.14), rgba(239,68,68,.06))}
  button:disabled{opacity:.55; cursor:not-allowed}

  .card{
    margin-top:14px; border:1px solid var(--line); border-radius:var(--r);
    background:linear-gradient(180deg, var(--panelA), var(--panelB));
    overflow:hidden;
  }
  .hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between; align-items:flex-start}
  .bd{padding:14px}
  .big{margin:0;font-size:26px;font-weight:950; letter-spacing:.2px}
  .hint{margin:8px 0 0;color:var(--muted);font-size:13px}
  .note{
    margin-top:10px; padding:10px 12px; border-radius:14px;
    border:1px solid rgba(238,242,255,.14); background:rgba(0,0,0,.12);
    color:rgba(238,242,255,.88); font-size:13px;
  }
  body.supported .note{ font-size:14px; }

  .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px}
  @media(max-width:980px){ .grid{ grid-template-columns: 1fr; } }

  .syllables{
    display:flex; gap:10px; flex-wrap:wrap; align-items:stretch;
    margin-top:12px;
  }
  .syll{
    flex:0 1 auto;
    min-width:96px;
    min-height:62px;
    padding:10px 14px;
    border-radius:16px;
    border:1px solid rgba(238,242,255,.16);
    background:rgba(255,255,255,.05);
    font-weight:950;
    letter-spacing:.4px;
    cursor:pointer;
    user-select:none;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    transition:transform .12s ease, background .12s ease, border-color .12s ease;
  }
  body.supported .syll{ min-width:110px; min-height:68px; }
  .syll:hover{ transform:translateY(-1px); border-color:rgba(56,189,248,.35); }
  .syll.sel{ border-color:rgba(56,189,248,.75); background:rgba(56,189,248,.12); }
  .syll.ok{ border-color:rgba(34,197,94,.75); background:rgba(34,197,94,.12); }
  .syll.no{ border-color:rgba(239,68,68,.75); background:rgba(239,68,68,.10); }

  .tag{
    position:absolute;
    top:8px; left:10px;
    font-size:12px; padding:2px 8px; border-radius:999px;
    border:1px solid rgba(238,242,255,.16);
    background:rgba(0,0,0,.18);
    color:rgba(238,242,255,.84);
    display:none;
  }
  body.supported .tag{ display:inline-block; }

  .beatBox{
    border:1px solid rgba(238,242,255,.14);
    border-radius:16px;
    background:rgba(0,0,0,.12);
    padding:12px;
  }
  .beatRow{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  }
  .meter{
    margin-top:12px;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .pulse{
    width:18px; height:18px;
    border-radius:999px;
    border:1px solid rgba(238,242,255,.18);
    background:rgba(255,255,255,.05);
    transition: transform .08s ease, background .08s ease, border-color .08s ease;
  }
  .pulse.on{ transform:scale(1.18); border-color:rgba(56,189,248,.65); background:rgba(56,189,248,.20); }
  .pulse.acc{ border-color:rgba(34,197,94,.75); background:rgba(34,197,94,.20); }

  .status{
    margin-top:12px; padding:10px 12px; border:1px solid var(--line); border-radius:14px;
    background:rgba(255,255,255,.03); font-size:13px; color:rgba(238,242,255,.88);
    display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between;
  }
  .okText{color:var(--ok); font-weight:950}
  .noText{color:var(--no); font-weight:950}

  details{margin-top:12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.10);padding:10px 12px}
  summary{cursor:pointer;font-weight:950;list-style:none}
  summary::-webkit-details-marker{display:none}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{border-bottom:1px solid rgba(238,242,255,.10); padding:8px 6px; text-align:left; vertical-align:top}
  th{font-weight:950}

  body.supported .bd{ text-align:left; }

  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:12px;
    padding:2px 6px;
    border-radius:8px;
    border:1px solid rgba(238,242,255,.16);
    background:rgba(0,0,0,.18);
    color:rgba(238,242,255,.86);
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Word Stress DJ</h1>
      <div class="sub">Tap the stressed syllable. If correct, the beat “locks in”. Supported adds gentle cues (same answers).</div>
    </div>
    <div class="row">
      <label class="row" style="gap:6px;color:var(--muted);font-size:13px">View
        <select id="variant">
          <option value="standard">Standard</option>
          <option value="supported">Supported</option>
        </select>
      </label>

      <label class="row" style="gap:6px;color:var(--muted);font-size:13px">Voice
        <select id="voice"></select>
      </label>

      <label class="row" style="gap:6px;color:var(--muted);font-size:13px">Tempo
        <input id="tempo" type="range" min="70" max="140" value="105" />
      </label>

      <button class="ghost" id="toggleBeat">Start beat</button>
      <button class="ghost" id="speakWord">Speak</button>
      <button class="ghost" id="speakSylls">Speak syllables</button>
      <button id="next">Next</button>
    </div>
  </header>

  <section class="card">
    <div class="hd">
      <div>
        <div class="sub">Now playing</div>
        <p class="big" id="word">—</p>
        <p class="hint" id="taskHint"></p>
      </div>
      <div class="row">
        <button class="ghost" id="clear">Clear</button>
        <button class="ghost" id="show">Show answer</button>
        <button class="bad" id="reduceMotion">Reduce motion</button>
      </div>
    </div>

    <div class="bd">
      <div class="grid">
        <div>
          <div class="sub">Tap the stressed syllable</div>
          <div class="syllables" id="syllables" aria-label="syllable choices"></div>

          <div class="note" id="supportNote" style="display:none"></div>

          <div class="status">
            <span>Status: <b id="status">ready</b></span>
            <span>Score: <b id="score">0</b>/<b id="total">0</b></span>
            <span>Beat: <b id="beatState">off</b> • <b id="tempoText">105</b> BPM</span>
          </div>

          <div class="note" style="margin-top:12px">
            Shortcut: <span class="kbd">1</span> <span class="kbd">2</span> <span class="kbd">3</span>… picks a syllable • <span class="kbd">Enter</span> speaks the word.
          </div>
        </div>

        <aside class="beatBox">
          <div class="sub">Beat visualiser</div>
          <div class="beatRow" style="margin-top:6px">
            <div>
              <div style="font-weight:950">Loop length</div>
              <div class="hint" id="loopHint">—</div>
            </div>
            <button class="ghost" id="tap">Tap tempo</button>
          </div>

          <div class="meter" id="meter" aria-label="beat meter"></div>

          <div class="note" style="margin-top:12px">
            <b>Teacher note:</b> stress can vary by accent. This pack uses a common classroom stress pattern.
            Edit the word list in the code if you want your local pronunciation.
          </div>

          <details style="margin-top:12px">
            <summary>Teacher Key</summary>
            <div class="hint" style="margin-top:10px" id="key"></div>
          </details>
        </aside>
      </div>
    </div>
  </section>
</div>

<script>
/* Word list: syllable chunks + stress index (0-based). Keep syllables neutral (no answer-hinting). */
const WORDS = [
  { word:"responsibility",   syll:["re","spon","si","bil","i","ty"],     stress:3, note:"Try clapping: one clap should feel strongest." },
  { word:"community",        syll:["com","mu","ni","ty"],                stress:1, note:"Listen for the loudest/longest beat." },
  { word:"conversation",     syll:["con","ver","sa","tion"],             stress:2, note:"-tion endings are often lighter." },
  { word:"international",    syll:["in","ter","na","tion","al"],         stress:2, note:"The stress often sits before -tion." },
  { word:"misunderstanding", syll:["mis","un","der","stand","ing"],      stress:3, note:"The base word often carries the main stress." },
  { word:"vocabulary",       syll:["vo","cab","u","lar","y"],            stress:1, note:"Find the ‘punchiest’ chunk." },
  { word:"attention",        syll:["a","tten","tion"],                   stress:1, note:"Middle stress is common here." },
  { word:"direction",        syll:["di","rec","tion"],                   stress:1, note:"Try: di-REC-tion." },
  { word:"decision",         syll:["de","ci","sion"],                    stress:1, note:"Try: de-CI-sion." },
  { word:"different",        syll:["dif","fer","ent"],                   stress:0, note:"First-syllable stress is very common." },
  { word:"together",         syll:["to","geth","er"],                    stress:1, note:"Try: to-GETH-er." },
  { word:"organise",         syll:["or","ga","nise"],                    stress:0, note:"Common BrE/IrE classroom stress: OR-ga-nise." },
];

const $ = (s, r=document) => r.querySelector(s);
const esc = (s)=>String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

/* ---------- TTS ---------- */
let voices=[];
function refreshVoices(){
  if(!window.speechSynthesis) return;
  voices = speechSynthesis.getVoices()||[];
  const sel=$("#voice"); sel.innerHTML="";
  const o0=document.createElement("option"); o0.value=""; o0.textContent=voices.length?"Default":"No voices"; sel.appendChild(o0);
  voices.forEach((v,i)=>{
    const o=document.createElement("option");
    o.value=String(i);
    o.textContent=`${v.name} (${v.lang})`;
    sel.appendChild(o);
  });
}
function speak(text, rate=1.0){
  if(!window.speechSynthesis) return;
  const u=new SpeechSynthesisUtterance(String(text||""));
  const idx=parseInt($("#voice").value,10);
  if(Number.isFinite(idx) && voices[idx]) u.voice=voices[idx];
  u.rate=Math.max(0.65, Math.min(1.15, rate));
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
async function speakSyllables(item){
  if(!window.speechSynthesis) return;
  const baseRate = (state.variant==="supported") ? 0.85 : 0.95;
  speechSynthesis.cancel();
  for(let i=0;i<item.syll.length;i++){
    const syll = item.syll[i].replace(/[^\w]/g,"");
    const u=new SpeechSynthesisUtterance(syll);
    const idx=parseInt($("#voice").value,10);
    if(Number.isFinite(idx) && voices[idx]) u.voice=voices[idx];
    u.rate=baseRate;
    speechSynthesis.speak(u);
    await new Promise(res=>{
      u.onend = ()=>setTimeout(res, 120);
      u.onerror = ()=>setTimeout(res, 120);
    });
  }
}

/* ---------- WebAudio beat ---------- */
let audioCtx=null;
let beatTimer=null;
let pulseIndex=0;

function getCtx(){
  if(audioCtx) return audioCtx;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function clickSound(accent=false){
  const ctx=getCtx();
  const t=ctx.currentTime;
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  const f = accent ? 660 : 440;
  o.type="square";
  o.frequency.setValueAtTime(f, t);
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(accent ? 0.12 : 0.08, t+0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.055);
  o.connect(g); g.connect(ctx.destination);
  o.start(t); o.stop(t+0.06);
}
function successSound(){
  const ctx=getCtx();
  const t=ctx.currentTime;
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.type="sine";
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.14, t+0.01);
  o.frequency.setValueAtTime(392, t);
  o.frequency.exponentialRampToValueAtTime(784, t+0.18);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.20);
  o.connect(g); g.connect(ctx.destination);
  o.start(t); o.stop(t+0.22);
}
function stopBeat(){
  if(beatTimer){ clearInterval(beatTimer); beatTimer=null; }
  pulseIndex=0;
  $("#beatState").textContent="off";
  $("#toggleBeat").textContent="Start beat";
  updateMeter(-1);
}
function startBeat(){
  if(beatTimer) return;
  const bpm = Number($("#tempo").value)||105;
  const msPerBeat = Math.round(60000 / bpm);
  $("#beatState").textContent="on";
  $("#toggleBeat").textContent="Stop beat";

  beatTimer = setInterval(()=>{
    const item = current();
    const n = item.syll.length || 1;
    const isAccent = state.locked && (pulseIndex === item.stress);
    clickSound(isAccent);
    updateMeter(pulseIndex);
    pulseIndex = (pulseIndex + 1) % n;
  }, msPerBeat);
}

/* ---------- State ---------- */
const state = {
  i: 0,
  variant: "standard",
  locked: false,
  selected: null,
  score: 0,
  seen: new Set(),
  tapTimes: [],
};

function current(){ return WORDS[state.i]; }

function setVariant(v){
  state.variant = (v==="supported") ? "supported" : "standard";
  document.body.classList.toggle("supported", state.variant==="supported");
  render();
}
function toggleReduceMotion(){
  const on = !document.body.classList.contains("reduceMotion");
  document.body.classList.toggle("reduceMotion", on);
  $("#reduceMotion").textContent = on ? "Motion reduced" : "Reduce motion";
}
function setStatus(html){ $("#status").innerHTML = html; }

function renderMeter(){
  const m=$("#meter"); m.innerHTML="";
  const n=current().syll.length;
  for(let i=0;i<n;i++){
    const d=document.createElement("div");
    d.className="pulse";
    d.setAttribute("aria-label","pulse "+(i+1));
    m.appendChild(d);
  }
  $("#loopHint").textContent = `${n} pulses (one per syllable)`;
  pulseIndex = 0;
  updateMeter(-1);
}
function updateMeter(active){
  const pulses=[...$("#meter").querySelectorAll(".pulse")];
  pulses.forEach((p,i)=>{
    p.classList.toggle("on", i===active);
    p.classList.toggle("acc", state.locked && i===current().stress);
  });
}
function renderSyllables(){
  const box=$("#syllables"); box.innerHTML="";
  const item=current();
  item.syll.forEach((s, idx)=>{
    const b=document.createElement("button");
    b.type="button";
    b.className="syll";
    b.setAttribute("aria-label", "syllable " + (idx+1) + " " + s.replace(/[^\w]/g,""));
    b.innerHTML = `<span class="tag">syll ${idx+1}</span><span>${esc(s.replace(/[^\w]/g,""))}</span>`;
    b.addEventListener("click",()=>pick(idx));
    box.appendChild(b);
  });
}
function pick(idx){
  if(state.locked) return;
  state.selected = idx;

  const nodes=[...$("#syllables").querySelectorAll(".syll")];
  nodes.forEach((n,i)=>{
    n.classList.remove("sel","ok","no");
    if(i===idx) n.classList.add("sel");
  });

  if(state.variant==="supported"){
    const s=current().syll[idx].replace(/[^\w]/g,"");
    speak(s, 0.92);
  }

  if(idx===current().stress){
    state.locked = true;
    nodes[idx].classList.add("ok");
    setStatus(`<span class="okText">locked ✅</span> — the beat now accents the stressed syllable`);
    successSound();

    if(!state.seen.has(state.i)){
      state.seen.add(state.i);
      state.score++;
      $("#score").textContent = String(state.score);
    }
    updateMeter(-1);
  } else {
    nodes[idx].classList.add("no");
    setStatus(`<span class="noText">not yet</span> — try another syllable`);
  }
}
function clearPick(){
  state.locked=false;
  state.selected=null;
  setStatus("ready");
  render();
}
function showAnswer(){
  if(state.locked) return;
  pick(current().stress);
}
function next(){
  state.i = (state.i + 1) % WORDS.length;
  state.locked=false;
  state.selected=null;
  setStatus("ready");
  render();
}
function renderKey(){
  const rows = WORDS.map((w,i)=>{
    const syl = w.syll.map((s,idx)=> idx===w.stress ? `<b>${esc(s)}</b>` : esc(s) ).join(" · ");
    return `<tr><td>${i+1}</td><td><b>${esc(w.word)}</b></td><td>${syl}</td><td>${w.stress+1}</td></tr>`;
  }).join("");
  $("#key").innerHTML = `
    <table>
      <thead><tr><th>#</th><th>Word</th><th>Syllables (stress in bold)</th><th>Stress #</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}
function renderHeader(){
  const item=current();
  $("#word").textContent = item.word;
  $("#taskHint").textContent = (state.variant==="supported")
    ? `Support: tap the syllable that sounds strongest. Then listen: the loop accents it.`
    : `Tap the stressed syllable. Then listen: the loop accents it.`;

  const note=$("#supportNote");
  if(state.variant==="supported"){
    note.style.display="block";
    note.innerHTML = `<b>Support tip:</b> ${esc(item.note)}<br><span style="color:rgba(238,242,255,.72)">Try: Speak → Speak syllables → Tap.</span>`;
  } else {
    note.style.display="none";
  }

  $("#total").textContent = String(WORDS.length);
  $("#score").textContent = String(state.score);
}
function render(){
  renderHeader();
  renderSyllables();
  renderMeter();
  renderKey();
  $("#tempoText").textContent = String($("#tempo").value||105);

  if(beatTimer){
    stopBeat();
    startBeat();
  }
}

/* Tap tempo */
function tapTempo(){
  const now = performance.now();
  state.tapTimes.push(now);
  state.tapTimes = state.tapTimes.slice(-6);
  if(state.tapTimes.length >= 3){
    const diffs=[];
    for(let i=1;i<state.tapTimes.length;i++) diffs.push(state.tapTimes[i]-state.tapTimes[i-1]);
    const avg = diffs.reduce((a,b)=>a+b,0)/diffs.length;
    const bpm = Math.max(70, Math.min(140, Math.round(60000/avg)));
    $("#tempo").value = String(bpm);
    $("#tempoText").textContent = String(bpm);
    if(beatTimer){ stopBeat(); startBeat(); }
  }
}

/* Keyboard shortcuts */
document.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){ speak(current().word, 0.95); return; }
  if(e.key>="1" && e.key<="9"){
    const idx = parseInt(e.key,10)-1;
    if(idx < current().syll.length) pick(idx);
  }
  if(e.key==="ArrowRight"){ next(); }
});

/* Wire up */
$("#variant").addEventListener("change",(e)=>setVariant(e.target.value));
$("#reduceMotion").addEventListener("click",toggleReduceMotion);
$("#clear").addEventListener("click",clearPick);
$("#show").addEventListener("click",showAnswer);
$("#next").addEventListener("click",next);

$("#toggleBeat").addEventListener("click", async ()=>{
  try{ await getCtx().resume(); }catch{}
  if(beatTimer) stopBeat(); else startBeat();
});

$("#tempo").addEventListener("input",()=>{
  $("#tempoText").textContent = String($("#tempo").value||105);
  if(beatTimer){ stopBeat(); startBeat(); }
});

$("#tap").addEventListener("click", async ()=>{
  try{ await getCtx().resume(); }catch{}
  tapTempo();
});

$("#speakWord").addEventListener("click",()=>speak(current().word, 0.95));
$("#speakSylls").addEventListener("click",()=>speakSyllables(current()));

/* voices */
refreshVoices();
if(window.speechSynthesis) speechSynthesis.onvoiceschanged = refreshVoices;

/* init */
render();
</script>
<!-- WORDINESS_FAILSAFE_PATCH v1 -->
<script id="wordiness-failsafe-patch">
(function(){
  if (window.__wordinessFailsafePatch) return;
  window.__wordinessFailsafePatch = true;

  const VOWEL = /[aeiouy]/i;

  const EXCEPTIONS = {
    different:   { spelling:["dif","fer","ent"], spoken:[["dif","frent"],["dif","rent"]] },
    vegetable:   { spelling:["ve","ge","ta","ble"], spoken:[["veg","ta","ble"],["vej","ta","bul"]] },
    factory:     { spelling:["fac","to","ry"], spoken:[["fac","tuh","ree"],["fac","tri"]] },
    family:      { spelling:["fam","i","ly"], spoken:[["fam","ly"]] },
    chocolate:   { spelling:["choc","o","late"], spoken:[["choc","late"]] },
    camera:      { spelling:["cam","er","a"], spoken:[["cam","ra"]] },
    interesting: { spelling:["in","ter","est","ing"], spoken:[["in","tres","ting"]] },
    probably:    { spelling:["prob","a","bly"], spoken:[["prob","ly"]] }
  };

  function hasVowelLetters(s){ return VOWEL.test(String(s||"")); }
  function lettersSpaced(s){ return String(s||"").split("").join(" "); }
  function onlyLetters(s){ return String(s||"").toLowerCase().replace(/[^a-z']/g,""); }

  function normalizeLine(s){
    return String(s||"")
      .replace(/[\u2010\u2011\u2012\u2013\u2014\u2212]/g, "-") // fancy dashes
      .replace(/\u00B7/g, "·") // middle dot
      .trim();
  }

  // Extract sensible words from pasted text, but preserve already-marked syllable lines
  function sanitizeSeedText(raw){
    raw = String(raw||"").replace(/\r/g,"");
    const out = [];
    for (const line0 of raw.split("\n")) {
      const line = normalizeLine(line0);
      if (!line) continue;

      // Keep marked syllable lines like dif-fer-ent (no spaces)
      if (/[-·]/.test(line) && !/\s/.test(line)) {
        out.push(line);
        continue;
      }

      // Otherwise extract word tokens from the line
      const toks = line.match(/[A-Za-z]+(?:'[A-Za-z]+)?/g);
      if (!toks) continue;
      for (const w of toks) {
        if (w.length > 28) continue;
        if (!hasVowelLetters(w)) continue;
        out.push(w);
      }
    }

    // de-dupe, preserve order
    const seen = new Set();
    const final = [];
    for (const w of out) {
      const k = w.toLowerCase();
      if (seen.has(k)) continue;
      seen.add(k);
      final.push(w);
    }
    return final.join("\n");
  }

  // Replace a specific line (by index) with chunked form, joined by '-'
  function replaceLine(text, lineIndex, newChunks){
    const lines = String(text||"").replace(/\r/g,"").split("\n");
    if (lineIndex < 0 || lineIndex >= lines.length) return text;
    lines[lineIndex] = newChunks.join("-");
    return lines.join("\n");
  }

  // Find a textarea likely used for word lists
  function findSeedTextarea(){
    return document.querySelector("textarea#input, textarea#seed, textarea[data-seed], textarea");
  }

  // Build helper UI under textarea: reduction suggestions + failsafe warnings + sanitize button
  function attachHelperUI(ta){
    if (!ta || ta.__wordinessHelperAttached) return;
    ta.__wordinessHelperAttached = true;

    const host = document.createElement("div");
    host.style.cssText = [
      "margin-top:10px",
      "border:1px solid rgba(255,255,255,.14)",
      "border-radius:14px",
      "padding:10px 12px",
      "background:rgba(0,0,0,.10)",
      "color:rgba(238,242,255,.85)",
      "font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial",
      "font-size:13px"
    ].join(";");

    const hdr = document.createElement("div");
    hdr.style.cssText = "display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;";
    hdr.innerHTML = `<b>Wordiness helpers</b>
      <span style="opacity:.8">failsafes + disappearing-vowel options</span>`;
    host.appendChild(hdr);

    const btnRow = document.createElement("div");
    btnRow.style.cssText = "display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;";
    const sanitizeBtn = document.createElement("button");
    sanitizeBtn.type = "button";
    sanitizeBtn.textContent = "Sanitize pasted text → words";
    sanitizeBtn.style.cssText =
      "cursor:pointer;border-radius:999px;padding:8px 10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);color:rgba(238,242,255,.92);font-weight:700;";
    btnRow.appendChild(sanitizeBtn);
    host.appendChild(btnRow);

    const msg = document.createElement("div");
    msg.style.cssText = "margin-top:10px;opacity:.9;";
    host.appendChild(msg);

    const sug = document.createElement("div");
    sug.style.cssText = "display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;";
    host.appendChild(sug);

    function refresh(){
      const raw = String(ta.value||"");
      const lines = raw.replace(/\r/g,"").split("\n").map(normalizeLine);
      sug.innerHTML = "";

      // Warnings: chunks with no vowel letters (only checks marked chunk lines)
      let warnCount = 0;
      for (const ln of lines) {
        if (!ln) continue;
        if (/[-·]/.test(ln) && !/\s/.test(ln)) {
          const parts = ln.split(/[-·]+/).map(s=>s.trim()).filter(Boolean);
          const bad = parts.filter(p=>!hasVowelLetters(p));
          if (bad.length) warnCount++;
        }
      }

      // Suggestions for disappearing vowels
      const found = [];
      lines.forEach((ln, i)=>{
        if (!ln) return;
        const key = onlyLetters(ln.replace(/[-·]/g,""));
        if (EXCEPTIONS[key]) found.push({ key, i });
      });

      msg.innerHTML =
        `${warnCount ? `<span style="color:#f59e0b;font-weight:800">${warnCount} warning(s)</span> (chunk has no vowel letters). ` : `<span style="color:#22c55e;font-weight:800">No failsafe warnings</span>. `}
         ${found.length ? `Found <b>${found.length}</b> reduction word(s).` : `No reduction words detected in list.`}`;

      // Make buttons for each found word
      found.slice(0, 12).forEach(({key, i})=>{
        const ex = EXCEPTIONS[key];
        const label = key;
        const makeBtn = (text, chunks) => {
          const b = document.createElement("button");
          b.type = "button";
          b.textContent = `${label}: ${text}`;
          b.style.cssText =
            "cursor:pointer;border-radius:999px;padding:8px 10px;border:1px solid rgba(56,189,248,.28);background:rgba(56,189,248,.08);color:rgba(238,242,255,.92);font-weight:800;";
          b.onclick = ()=>{
            ta.value = replaceLine(ta.value, i, chunks);
            ta.dispatchEvent(new Event("input", { bubbles:true }));
          };
          return b;
        };

        if (ex.spelling) sug.appendChild(makeBtn("Use spelling", ex.spelling));
        if (Array.isArray(ex.spoken)) {
          ex.spoken.forEach(opt => sug.appendChild(makeBtn("Use spoken", opt)));
        }
      });
    }

    sanitizeBtn.onclick = ()=>{
      const before = ta.value;
      const after = sanitizeSeedText(before);
      if (after && after !== before) {
        ta.value = after;
        ta.dispatchEvent(new Event("input", { bubbles:true }));
      }
    };

    // Insert right after textarea
    ta.insertAdjacentElement("afterend", host);

    // Live update
    let t = null;
    ta.addEventListener("input", ()=>{
      clearTimeout(t);
      t = setTimeout(refresh, 120);
    });
    refresh();
  }

  // TTS fail-safe wrapper: if no vowel letters and short, speak letters spaced
  function wrapSpeak(fnName){
    const old = window[fnName];
    if (typeof old !== "function") return;
    if (old.__wordinessWrapped) return;

    function wrapped(text, ...rest){
      const t = String(text||"").trim();
      if (t && !hasVowelLetters(t) && t.length <= 8) {
        return old.call(this, lettersSpaced(t), ...rest);
      }
      return old.call(this, text, ...rest);
    }
    wrapped.__wordinessWrapped = true;
    window[fnName] = wrapped;
  }

  // Try common TTS function names used across your games
  ["speakNow","speak","speakText","say"].forEach(wrapSpeak);

  // Seed sanitiser if game uses #seed=
  function patchSeedFromHash(){
    const h = String(location.hash||"");
    if (!/seed=/.test(h)) return;
    const ta = findSeedTextarea();
    if (!ta) return;
    const before = ta.value;
    const after = sanitizeSeedText(before);
    if (after && after !== before) {
      ta.value = after;
      ta.dispatchEvent(new Event("input", { bubbles:true }));
    }
  }

  // Attach helpers on load
  function boot(){
    const ta = findSeedTextarea();
    if (ta) attachHelperUI(ta);
    patchSeedFromHash();
  }

  window.addEventListener("hashchange", ()=>setTimeout(patchSeedFromHash, 0));
  setTimeout(boot, 80);

})();
</script>
<!-- /WORDINESS_FAILSAFE_PATCH v1 -->
</body>
</html>
