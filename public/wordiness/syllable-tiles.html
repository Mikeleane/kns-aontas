<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wordiness â€” Syllable Tiles Studio (Fixed v4)</title>
<style>
  :root{
    --bg:#070b16; --line:rgba(255,255,255,.14);
    --text:#eef2ff; --muted:rgba(238,242,255,.70);
    --acc:#38bdf8; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --r:18px; --fs:18px; --lh:1.65; --ls:0px; --ws:0px;
  }
  body.supported{ --fs:20px; --lh:1.95; --ls:.2px; --ws:.8px; }
  body{ margin:0; color:var(--text);
        background:
          radial-gradient(900px 500px at 20% -10%, rgba(56,189,248,.14), transparent 60%),
          radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.12), transparent 55%),
          linear-gradient(180deg,#050816,var(--bg));
        font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
        font-size:var(--fs); line-height:var(--lh); letter-spacing:var(--ls); word-spacing:var(--ws); }
  .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
  header{ position:sticky; top:10px; z-index:5; backdrop-filter: blur(10px);
          border:1px solid var(--line); border-radius:var(--r); padding:12px 14px;
          background:linear-gradient(180deg, rgba(20,30,55,.85), rgba(10,18,38,.78));
          display:flex; gap:12px; flex-wrap:wrap; justify-content:space-between; align-items:center; }
  h1{ margin:0; font-size:18px; }
  .sub{ color:var(--muted); font-size:13px; margin-top:3px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  select,button,textarea{ font:inherit; }
  select{ background:rgba(0,0,0,.25); color:var(--text); border:1px solid var(--line); padding:8px 10px; border-radius:12px; }
  button{ cursor:pointer; color:var(--text); border:1px solid rgba(56,189,248,.32);
          background:linear-gradient(180deg, rgba(56,189,248,.14), rgba(56,189,248,.06));
          padding:10px 12px; border-radius:12px; }
  button.ghost{ border:1px solid var(--line); background:rgba(255,255,255,.04); }
  .card{ margin-top:14px; border:1px solid var(--line); border-radius:var(--r);
         background:linear-gradient(180deg, rgba(16,27,51,.78), rgba(11,20,40,.72)); overflow:hidden; }
  .hd{ padding:12px 14px; border-bottom:1px solid var(--line); display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:flex-start; }
  .bd{ padding:14px; }
  textarea{ width:100%; min-height:120px; resize:vertical; border-radius:14px; padding:12px;
            border:1px solid var(--line); background:rgba(0,0,0,.18); color:var(--text); }
  .hint{ margin:10px 0 0; color:var(--muted); font-size:13px; }
  .tiles{ margin-top:14px; display:grid; gap:12px; }
  .wordRow{ border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(0,0,0,.10); }
  .topline{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between; }
  .w{ font-weight:1000; font-size:24px; }
  .sy{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .tile{ border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.04); color:rgba(238,242,255,.92);
         border-radius:999px; padding:10px 12px; font-weight:950; cursor:pointer; user-select:none; }
  body.supported .tile{ padding:12px 14px; }
  .status{ margin-top:12px; border:1px solid var(--line); border-radius:14px; padding:10px 12px; background:rgba(255,255,255,.03);
           font-size:13px; color:rgba(238,242,255,.88); }
  .ok{ color:var(--ok); font-weight:950; }
  .bad{ color:var(--bad); font-weight:950; }
  .warn{ color:var(--warn); font-weight:950; }
  code{ background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); padding:1px 6px; border-radius:10px; }
  details{ margin-top:10px; border:1px solid rgba(255,255,255,.10); border-radius:14px; background:rgba(0,0,0,.10); padding:10px 12px; }
  summary{ cursor:pointer; font-weight:950; list-style:none; }
  summary::-webkit-details-marker{ display:none; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; color:rgba(238,242,255,.78); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Wordiness â€” Syllable Tiles Studio (Fixed v4)</h1>
      <div class="sub">v4 removes aggressive â€œcleaningâ€ completely (it caused weird outputs like <b>sps</b>). We now only normalize dashes and split.</div>
    </div>
    <div class="row">
      <label class="row" style="gap:6px;color:var(--muted);font-size:13px">View
        <select id="variant">
          <option value="standard">Standard</option>
          <option value="supported">Supported</option>
        </select>
      </label>
      <label class="row" style="gap:6px;color:var(--muted);font-size:13px">Voice
        <select id="voice"></select>
      </label>
      <button class="ghost" id="stop" type="button">Stop</button>
      <button class="ghost" id="render" type="button">Render tiles</button>
    </div>
  </header>

  <section class="card">
    <div class="hd">
      <div>
        <div class="sub">Input</div>
        <div class="hint">
          One word per line. Use <b>-</b> or <b>Â·</b> between syllables.<br>
          Fancy dashes <b>â€“</b> <b>â€”</b> <b>â€‘</b> <b>âˆ’</b> are auto-normalized to <b>-</b>.
        </div>
      </div>
      <div class="row">
        <button class="ghost" id="demo" type="button">Load demo</button>
        <button id="speakAll" type="button">Speak all (slow)</button>
      </div>
    </div>

    <div class="bd">
      <textarea id="input" spellcheck="false" placeholder="re-spon-si-bi-li-ty&#10;in-for-ma-tion&#10;op-por-tu-ni-ty"></textarea>
      <div class="status" id="status">Tip: click <b>Load demo</b>. If you still get nonsense, open Diagnostics and weâ€™ll see the exact characters.</div>
      <details>
        <summary>Diagnostics (debug)</summary>
        <div class="mono" id="diag"></div>
      </details>
      <div class="tiles" id="tiles"></div>
    </div>
  </section>
</div>

<script>
const $ = (s,r=document)=>r.querySelector(s);

/* ---------- Voice / TTS ---------- */
let voices=[];
function refreshVoices(){
  if(!window.speechSynthesis) return;
  voices = speechSynthesis.getVoices()||[];
  const sel=$("#voice"); sel.innerHTML="";
  const d=document.createElement("option");
  d.value=""; d.textContent=voices.length?"Default":"No voices";
  sel.appendChild(d);
  voices.forEach((v,i)=>{
    const o=document.createElement("option");
    o.value=String(i);
    o.textContent=`${v.name} (${v.lang})`;
    sel.appendChild(o);
  });
}
function speakNow(text, rate=0.9){
  if(!window.speechSynthesis) return;
  const t = String(text||"").trim();
  if(!t) return;
  const synth = window.speechSynthesis;

  const u=new SpeechSynthesisUtterance(t);
  const idx=parseInt($("#voice").value,10);
  if(Number.isFinite(idx) && voices[idx]) u.voice=voices[idx];
  u.rate=Math.max(0.7, Math.min(1.05, rate));

  try{ synth.cancel(); }catch{}
  // micro-delay prevents clipping on some browsers
  setTimeout(()=>{ try{ synth.speak(u); }catch{} }, 60);
}
async function speakChunks(chunks, rate=0.86){
  if(!window.speechSynthesis) return;
  const synth = window.speechSynthesis;
  try{ synth.cancel(); }catch{}
  for(const ch of chunks){
    const t = String(ch||"").trim();
    if(!t) continue;
    const u=new SpeechSynthesisUtterance(t);
    const idx=parseInt($("#voice").value,10);
    if(Number.isFinite(idx) && voices[idx]) u.voice=voices[idx];
    u.rate=Math.max(0.7, Math.min(1.05, rate));
    synth.speak(u);
    await new Promise(res=>{
      u.onend=()=>setTimeout(res,140);
      u.onerror=()=>setTimeout(res,140);
    });
  }
}

/* ---------- Parsing (NO aggressive cleaning) ---------- */
const DASHES = /[\u2010\u2011\u2012\u2013\u2014\u2212]/g; // â€ â€‘ â€’ â€“ â€” âˆ’
function normalizeLine(s){
  return String(s||"")
    .replace(DASHES, "-")
    .replace(/\u00B7/g, "Â·"); // middle dot
}

function parseLines(raw){
  return String(raw||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
}
function splitSyllables(line){
  const norm = normalizeLine(line).trim();

  // Keep the raw text as-is (no stripping). Just split on hyphen/middle-dot sequences.
  const parts = norm.split(/[-Â·]+/).map(s=>s.trim()).filter(Boolean);

  // Build whole word: join parts, then remove spaces inside (just in case).
  const whole = parts.join("").replace(/\s+/g,"");
  const spacedWhole = parts.join(" ");

  return { parts, whole, spacedWhole, marked: norm };
}

function esc(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function toCodePoints(s){
  const arr = [];
  for (const ch of String(s||"")) {
    const cp = ch.codePointAt(0).toString(16).toUpperCase().padStart(4,"0");
    arr.push(`U+${cp} '${ch === " " ? "â " : ch}'`);
  }
  return arr.join(", ");
}

function render(){
  const raw = $("#input").value;
  const lines = parseLines(raw);
  const holder=$("#tiles"); holder.innerHTML="";
  if(!lines.length){
    $("#status").innerHTML = '<span class="bad">No input yet.</span> Add a word, or press <b>Load demo</b>.';
    $("#diag").textContent = "No lines.";
    return;
  }

  let rendered = 0;
  const diagLines = [];
  lines.forEach((ln, idx)=>{
    const {parts, whole, spacedWhole, marked} = splitSyllables(ln);

    diagLines.push(`Line ${idx+1} raw: ${ln}`);
    diagLines.push(`Line ${idx+1} marked(normalized): ${marked}`);
    diagLines.push(`Line ${idx+1} codepoints: ${toCodePoints(marked)}`);
    diagLines.push(`Line ${idx+1} parts: [${parts.map(p=>`"${p}"`).join(", ")}]`);
    diagLines.push(`Line ${idx+1} whole: "${whole}"`);
    diagLines.push("");

    const row=document.createElement("div");
    row.className="wordRow";
    row.innerHTML = `
      <div class="topline">
        <div>
          <div class="w">${esc(whole || "â€”")}</div>
          <div class="hint">Marked: <code>${esc(marked)}</code></div>
        </div>
        <div class="row">
          <button class="ghost" data-act="chunks" type="button">Speak chunks</button>
          <button class="ghost" data-act="blendSlow" type="button">Blend (slow)</button>
          <button data-act="blend" type="button">Blend</button>
        </div>
      </div>
      <div class="sy"></div>
    `;

    const sy=row.querySelector(".sy");
    parts.forEach(p=>{
      const t=document.createElement("button");
      t.className="tile";
      t.type="button";
      t.textContent=p;
      t.onclick=()=>speakNow(p, 0.9);
      sy.appendChild(t);
    });

    const isSupported = ()=>document.body.classList.contains("supported");
    row.querySelector('[data-act="blend"]').onclick=()=>speakNow(whole, isSupported()?0.86:0.95);
    row.querySelector('[data-act="blendSlow"]').onclick=()=>speakNow(spacedWhole, isSupported()?0.82:0.9);
    row.querySelector('[data-act="chunks"]').onclick=()=>speakChunks(parts, isSupported()?0.82:0.9);

    holder.appendChild(row);
    rendered++;
  });

  $("#diag").textContent = diagLines.join("\n");
  $("#status").innerHTML = `Rendered <b>${rendered}</b> word(s). If Blend clips, try <b>Blend (slow)</b>.`;
}

/* ---------- Wiring ---------- */
$("#variant").onchange=(e)=>document.body.classList.toggle("supported", e.target.value==="supported");
$("#render").onclick=render;
$("#stop").onclick=()=>{ try{ speechSynthesis.cancel(); }catch{} };
$("#demo").onclick=()=>{
  $("#input").value =
`re-spon-si-bi-li-ty
in-for-ma-tion
op-por-tu-ni-ty
dif-fi-cult
in-ter-est-ing
a-ma-zing`;
  render();
};
$("#speakAll").onclick=async ()=>{
  const lines = parseLines($("#input").value);
  const isSupported = ()=>document.body.classList.contains("supported");
  for(const ln of lines){
    const {parts, whole} = splitSyllables(ln);
    await speakChunks(parts, isSupported()?0.82:0.9);
    speakNow(whole, isSupported()?0.86:0.95);
    await new Promise(res=>setTimeout(res, 520));
  }
};

  // --- Seed from URL hash: #seed=... (URL-encoded) ---
  function applySeedFromHash(){
    try{
      const h = String(location.hash||"");
      const m = h.match(/(?:^#|&)seed=([^&]+)/);
      if(!m) return;
      const seed = decodeURIComponent(m[1]||"").replace(/\r/g,"");
      const ta = document.querySelector('#input');
      if(ta && seed.trim()){
        ta.value = seed;
        if(typeof window.render === 'function') window.render();
        else if(typeof render === 'function') render();
      }
    }catch(e){}
  }
  window.addEventListener('hashchange', applySeedFromHash);
  setTimeout(applySeedFromHash, 80);
refreshVoices();
if(window.speechSynthesis) speechSynthesis.onvoiceschanged = refreshVoices;

// Auto-render after typing/paste
let t=null;
$("#input").addEventListener("input", ()=>{
  clearTimeout(t);
  t=setTimeout(render, 200);
});
</script>
</body>
</html>

