<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Wordiness — DJ Remix (Stress & Rhythm)</title>
<style>
  :root{
    --text:#eef2ff; --muted:rgba(238,242,255,.72); --line:rgba(238,242,255,.16);
    --ok:#22c55e; --no:#ef4444; --acc:#38bdf8; --warn:#f59e0b;
    --r:18px; --base:18px; --lh:1.7; --ls:0px; --ws:0px;
    --panelA: rgba(16,27,51,.78);
    --panelB: rgba(11,20,40,.72);
  }
  body.supported{ --base:19px; --lh:1.9; --ls:.2px; --ws:.7px; }
  body.reduceMotion *{ transition:none !important; animation:none !important; scroll-behavior:auto !important; }
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    font-size:var(--base); line-height:var(--lh); letter-spacing:var(--ls); word-spacing:var(--ws);
    background:
      radial-gradient(900px 500px at 15% -10%, rgba(56,189,248,.14), transparent 60%),
      radial-gradient(900px 500px at 92% 10%, rgba(34,197,94,.12), transparent 55%),
      linear-gradient(180deg,#050816,#070b16 55%,#050816);
  }
  .wrap{max-width:1180px;margin:0 auto;padding:16px}
  header{
    position:sticky; top:10px; z-index:10;
    backdrop-filter: blur(10px);
    border:1px solid var(--line); border-radius:var(--r);
    background:linear-gradient(180deg, rgba(16,27,51,.88), rgba(11,20,40,.78));
    padding:12px 14px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  }
  h1{margin:0;font-size:18px}
  .sub{margin-top:2px;color:var(--muted);font-size:13px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,button,input{font:inherit}
  select, input[type="range"]{
    background:rgba(0,0,0,.25); color:var(--text);
    border:1px solid var(--line); padding:8px 10px; border-radius:12px; outline:none;
  }
  input[type="range"]{ padding:0; height:36px; }
  button{
    cursor:pointer; border-radius:12px; padding:10px 12px; color:var(--text);
    border:1px solid rgba(34,197,94,.35);
    background:linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.08));
  }
  button.ghost{border:1px solid var(--line); background:rgba(255,255,255,.04)}
  button:disabled{opacity:.55; cursor:not-allowed}
  .card{ margin-top:14px; border:1px solid var(--line); border-radius:var(--r);
    background:linear-gradient(180deg, var(--panelA), var(--panelB)); overflow:hidden; }
  .hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between; align-items:flex-start}
  .bd{padding:14px}
  .big{margin:0;font-size:26px;font-weight:950; letter-spacing:.2px}
  .hint{margin:8px 0 0;color:var(--muted);font-size:13px}
  .note{ margin-top:10px; padding:10px 12px; border-radius:14px;
    border:1px solid rgba(238,242,255,.14); background:rgba(0,0,0,.12);
    color:rgba(238,242,255,.88); font-size:13px; }
  body.supported .note{ font-size:14px; }
  .grid{display:grid; grid-template-columns: 1.25fr .75fr; gap:14px}
  @media(max-width:980px){ .grid{ grid-template-columns: 1fr; } }
  .pillRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .pill{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px;
    border:1px solid rgba(238,242,255,.14); background:rgba(255,255,255,.05);
    color:rgba(238,242,255,.88); font-size:13px; }
  .syllables{ display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; margin-top:12px; }
  .syll{ flex:0 1 auto; min-width:96px; min-height:62px; padding:10px 14px; border-radius:16px;
    border:1px solid rgba(238,242,255,.16); background:rgba(255,255,255,.05);
    font-weight:950; letter-spacing:.4px; cursor:pointer; user-select:none;
    display:flex; align-items:center; justify-content:center; position:relative;
    transition:transform .12s ease, background .12s ease, border-color .12s ease; }
  body.supported .syll{ min-width:110px; min-height:68px; }
  .syll:hover{ transform:translateY(-1px); border-color:rgba(56,189,248,.35); }
  .syll.sel{ border-color:rgba(56,189,248,.75); background:rgba(56,189,248,.12); }
  .syll.ok{ border-color:rgba(34,197,94,.75); background:rgba(34,197,94,.12); }
  .syll.no{ border-color:rgba(239,68,68,.75); background:rgba(239,68,68,.10); }
  .tag{ position:absolute; top:8px; left:10px; font-size:12px; padding:2px 8px; border-radius:999px;
    border:1px solid rgba(238,242,255,.16); background:rgba(0,0,0,.18); color:rgba(238,242,255,.84); display:none; }
  body.supported .tag{ display:inline-block; }
  .meter{ margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .pulse{ width:18px; height:18px; border-radius:999px; border:1px solid rgba(238,242,255,.18);
    background:rgba(255,255,255,.05); transition: transform .08s ease, background .08s ease, border-color .08s ease; }
  .pulse.on{ transform:scale(1.18); border-color:rgba(56,189,248,.65); background:rgba(56,189,248,.20); }
  .pulse.acc{ border-color:rgba(34,197,94,.75); background:rgba(34,197,94,.20); }
  .pulse.tgt{ border-color:rgba(245,158,11,.80); background:rgba(245,158,11,.18); }
  .status{ margin-top:12px; padding:10px 12px; border:1px solid var(--line); border-radius:14px;
    background:rgba(255,255,255,.03); font-size:13px; color:rgba(238,242,255,.88);
    display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; }
  .okText{color:var(--ok); font-weight:950}
  .noText{color:var(--no); font-weight:950}
  .warnText{color:var(--warn); font-weight:950}
  .twoCol{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
  @media(max-width:720px){ .twoCol{ grid-template-columns:1fr; } }
  .miniCard{ border:1px solid rgba(238,242,255,.14); border-radius:16px; background:rgba(0,0,0,.12); padding:12px; }
  .label{ font-weight:950; }
  .choiceBtn{ width:100%; justify-content:center; font-weight:950; }
  .choiceBtn.good{ border-color:rgba(34,197,94,.55); background:linear-gradient(180deg, rgba(34,197,94,.22), rgba(34,197,94,.10)); }
  .choiceBtn.bad{ border-color:rgba(239,68,68,.45); background:linear-gradient(180deg, rgba(239,68,68,.16), rgba(239,68,68,.08)); }
  details{margin-top:12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.10);padding:10px 12px}
  summary{cursor:pointer;font-weight:950;list-style:none}
  summary::-webkit-details-marker{display:none}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{border-bottom:1px solid rgba(238,242,255,.10); padding:8px 6px; text-align:left; vertical-align:top}
  th{font-weight:950}
  body.supported .bd{ text-align:left; }
  .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:12px; padding:2px 6px; border-radius:8px; border:1px solid rgba(238,242,255,.16);
    background:rgba(0,0,0,.18); color:rgba(238,242,255,.86); }
  .hidden{ display:none !important; }
</style>
<style>
/* wordiness-ui-polish-v4 */
:root{
  --tapMin: 44px;
  --safeBottom: env(safe-area-inset-bottom, 0px);
}
html, body{ height: 100%; }
body{
  min-height: 100dvh;
  padding-bottom: var(--safeBottom);
  -webkit-text-size-adjust: 100%;
  overscroll-behavior: contain;
}
@supports (height: 100svh){ body{ min-height: 100svh; } }

*{ -webkit-tap-highlight-color: transparent; }

button, [role="button"], a, input, select, textarea,
.tile, .wordCard, .slot, .badge{
  min-height: var(--tapMin);
}

button, [role="button"], a, .tile, .wordCard, .slot{
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
}

input, textarea, select{
  font-size: 16px !important; /* prevent iOS zoom */
}

[draggable="true"], .wordiness-draggable{
  touch-action: none; /* reduce scroll-vs-drag fighting */
}

.wordiness-drag-selected{
  outline: 3px solid rgba(56,189,248,.55) !important;
}

@media (prefers-reduced-motion: reduce){
  *{ scroll-behavior: auto !important; transition: none !important; animation: none !important; }
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Wordiness — DJ Remix</h1>
      <div class="sub">Practice (pick stress) + Remix (A/B stress pattern match). Supported adds cues without changing answers.</div>
    </div>
    <div class="row">
      <label class="row" style="gap:6px;color:var(--muted);font-size:13px">Mode
        <select id="mode">
          <option value="practice">Practice</option>
          <option value="remix">Remix</option>
        </select>
      </label>
      <label class="row" style="gap:6px;color:var(--muted);font-size:13px">View
        <select id="variant">
          <option value="standard">Standard</option>
          <option value="supported">Supported</option>
        </select>
      </label>
      <label class="row" style="gap:6px;color:var(--muted);font-size:13px">Voice
        <select id="voice"></select>
      </label>
      <label class="row" style="gap:6px;color:var(--muted);font-size:13px">Tempo
        <input id="tempo" type="range" min="70" max="140" value="108" />
      </label>
      <button class="ghost" id="toggleMetro">Metronome</button>
      <button class="ghost" id="reduceMotion">Reduce motion</button>
      <button id="nextTop">Next</button>
    </div>
  </header>

  <section class="card">
    <div class="hd">
      <div>
        <div class="sub">Now playing</div>
        <p class="big" id="titleBig">—</p>
        <p class="hint" id="taskHint"></p>
      </div>
      <div class="pillRow">
        <span class="pill">Score <b id="score">0</b>/<b id="total">∞</b></span>
        <span class="pill">Tempo <b id="tempoText">108</b> BPM</span>
        <span class="pill">Metronome <b id="metroState">off</b></span>
        <button class="ghost" id="speakWord">Speak</button>
        <button class="ghost" id="speakSylls">Speak syllables</button>
        <button class="ghost" id="showAnswer">Show answer</button>
        <button class="ghost" id="clear">Clear</button>
      </div>
    </div>

    <div class="bd">
      <div class="grid">
        <div>
          <div id="practicePane">
            <div class="sub">Tap the stressed syllable</div>
            <div class="syllables" id="syllables"></div>
            <div class="note" id="supportNote" style="display:none"></div>
            <div class="status">
              <span>Status: <b id="status">ready</b></span>
              <span>Shortcut: <span class="kbd">1</span> <span class="kbd">2</span> <span class="kbd">3</span>… pick syllable</span>
              <span>Shortcut: <span class="kbd">Enter</span> speaks</span>
            </div>
            <div class="meter" id="meterPractice"></div>
          </div>

          <div id="remixPane" class="hidden">
            <div class="sub">Match the stress pattern</div>
            <div class="note">Target: the main stress lands on <b>syllable #<span id="targetN">—</span></b>. Preview A/B then choose.</div>
            <div class="meter" id="meterTarget"></div>

            <div class="twoCol">
              <div class="miniCard">
                <div class="pillRow" style="justify-content:space-between">
                  <div class="label">Option A</div>
                  <button class="ghost" id="prevA">Preview A</button>
                </div>
                <div id="aText" class="hint" style="margin-top:6px"></div>
                <div id="aSyll" class="syllables" style="margin-top:10px"></div>
                <div class="meter" id="meterA"></div>
                <button class="choiceBtn ghost" id="chooseA" style="margin-top:10px">Choose A</button>
              </div>

              <div class="miniCard">
                <div class="pillRow" style="justify-content:space-between">
                  <div class="label">Option B</div>
                  <button class="ghost" id="prevB">Preview B</button>
                </div>
                <div id="bText" class="hint" style="margin-top:6px"></div>
                <div id="bSyll" class="syllables" style="margin-top:10px"></div>
                <div class="meter" id="meterB"></div>
                <button class="choiceBtn ghost" id="chooseB" style="margin-top:10px">Choose B</button>
              </div>
            </div>

            <div class="note" id="remixSupport" style="display:none"></div>
            <div class="status">
              <span>Status: <b id="remixStatus">ready</b></span>
              <span>Shortcut: <span class="kbd">A</span>/<span class="kbd">B</span> choose • <span class="kbd">P</span> preview A • <span class="kbd">O</span> preview B</span>
            </div>
          </div>
        </div>

        <aside class="miniCard">
          <div class="sub">Teacher Key</div>
          <details style="margin-top:10px" open>
            <summary>Show / hide</summary>
            <div class="hint" style="margin-top:10px" id="key"></div>
          </details>
          <div class="note">
            Stress can vary by accent. Edit the <span class="kbd">WORDS</span> list to match your classroom pronunciation.
          </div>
        </aside>
      </div>
    </div>
  </section>
</div>

<script>
/*
  Wordiness — DJ Remix
  - No paragraph-to-mega-word stuff: syllables are explicit arrays.
  - Supported view adds cues without changing the answer key.
*/

const WORDS = [
  // 3 syllables
  { word:"different",     syll:["dif","fer","ent"],            stress:0, note:"First-syllable stress is common." },
  { word:"remember",      syll:["re","mem","ber"],             stress:1, note:"Try: re-MEM-ber." },
  { word:"banana",        syll:["ba","na","na"],               stress:1, note:"Try: ba-NA-na." },
  { word:"decision",      syll:["de","ci","sion"],             stress:1, note:"Try: de-CI-sion." },
  { word:"direction",     syll:["di","rec","tion"],            stress:1, note:"Try: di-REC-tion." },
  { word:"computer",      syll:["com","pu","ter"],             stress:1, note:"Try: com-PU-ter." },
  { word:"yesterday",     syll:["yes","ter","day"],            stress:0, note:"Try: YES-ter-day." },

  // 4 syllables
  { word:"community",     syll:["com","mu","ni","ty"],         stress:1, note:"Listen for the strongest beat." },
  { word:"conversation",  syll:["con","ver","sa","tion"],      stress:2, note:"-tion endings are often lighter." },
  { word:"education",     syll:["e","du","ca","tion"],         stress:2, note:"Try: e-du-CA-tion." },

  // 5 syllables
  { word:"international", syll:["in","ter","na","tion","al"],  stress:2, note:"Stress often sits before -tion." },
  { word:"curiosity",     syll:["cu","ri","o","si","ty"],      stress:2, note:"Try: cu-ri-O-si-ty." },

  // 6 syllables
  { word:"responsibility",syll:["re","spon","si","bil","i","ty"],stress:3, note:"One chunk should feel strongest." },
  { word:"misunderstanding",syll:["mis","un","der","stand","ing"],stress:3, note:"The base word takes the punch." },
];

const $ = (s, r=document) => r.querySelector(s);
const esc = (s)=>String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

/* TTS */
let voices=[];
function refreshVoices(){
  if(!window.speechSynthesis) return;
  voices = speechSynthesis.getVoices()||[];
  const sel=$("#voice"); sel.innerHTML="";
  const o0=document.createElement("option"); o0.value=""; o0.textContent=voices.length?"Default":"No voices"; sel.appendChild(o0);
  voices.forEach((v,i)=>{
    const o=document.createElement("option");
    o.value=String(i);
    o.textContent=`${v.name} (${v.lang})`;
    sel.appendChild(o);
  });
}
function speak(text, rate=1.0){
  if(!window.speechSynthesis) return;
  const u=new SpeechSynthesisUtterance(String(text||""));
  const idx=parseInt($("#voice").value,10);
  if(Number.isFinite(idx) && voices[idx]) u.voice=voices[idx];
  u.rate=Math.max(0.65, Math.min(1.15, rate));
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
async function speakSyllables(item){
  if(!window.speechSynthesis) return;
  const baseRate = (state.variant==="supported") ? 0.85 : 0.95;
  speechSynthesis.cancel();
  for(let i=0;i<item.syll.length;i++){
    const s = item.syll[i].replace(/[^\w]/g,"");
    const u=new SpeechSynthesisUtterance(s);
    const idx=parseInt($("#voice").value,10);
    if(Number.isFinite(idx) && voices[idx]) u.voice=voices[idx];
    u.rate=baseRate;
    speechSynthesis.speak(u);
    await new Promise(res=>{
      u.onend = ()=>setTimeout(res, 120);
      u.onerror = ()=>setTimeout(res, 120);
    });
  }
}

/* WebAudio */
let audioCtx=null;
function getCtx(){
  if(audioCtx) return audioCtx;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function clickSound(accent=false){
  const ctx=getCtx();
  const t=ctx.currentTime;
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  const f = accent ? 720 : 440;
  o.type="square";
  o.frequency.setValueAtTime(f, t);
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(accent ? 0.12 : 0.08, t+0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.055);
  o.connect(g); g.connect(ctx.destination);
  o.start(t); o.stop(t+0.06);
}
function successSound(){
  const ctx=getCtx();
  const t=ctx.currentTime;
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.type="sine";
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.14, t+0.01);
  o.frequency.setValueAtTime(392, t);
  o.frequency.exponentialRampToValueAtTime(784, t+0.18);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.20);
  o.connect(g); g.connect(ctx.destination);
  o.start(t); o.stop(t+0.22);
}

/* Metronome */
let metroTimer=null;
let metroPhase=0;
function stopMetro(){
  if(metroTimer){ clearInterval(metroTimer); metroTimer=null; }
  $("#metroState").textContent="off";
  $("#toggleMetro").textContent="Metronome";
  metroPhase=0;
}
function startMetro(){
  if(metroTimer) return;
  $("#metroState").textContent="on";
  $("#toggleMetro").textContent="Stop metro";
  const bpm = Number($("#tempo").value)||108;
  const ms = Math.round(60000 / bpm);
  metroTimer = setInterval(()=>{
    const accent = (metroPhase % 4) === 0;
    clickSound(accent);
    metroPhase++;
  }, ms);
}

/* State */
const state = {
  mode: "practice",
  variant: "standard",
  i: 0,
  locked: false,
  selected: null,
  score: 0,
  remix: { a:0, b:1, n:3, target:2, correct:"A", locked:false }
};

function setVariant(v){
  state.variant = (v==="supported") ? "supported" : "standard";
  document.body.classList.toggle("supported", state.variant==="supported");
  render();
}
function setMode(m){
  state.mode = (m==="remix") ? "remix" : "practice";
  $("#practicePane").classList.toggle("hidden", state.mode!=="practice");
  $("#remixPane").classList.toggle("hidden", state.mode!=="remix");
  stopMetro();
  clearLocks();
  if(state.mode==="remix") newRemixRound();
  render();
}
function clearLocks(){
  state.locked=false;
  state.selected=null;
  state.remix.locked=false;
  $("#status").textContent="ready";
  $("#remixStatus").textContent="ready";
  ["chooseA","chooseB"].forEach(id=>{
    const b=$("#"+id);
    b.classList.remove("good","bad");
    b.textContent = id==="chooseA" ? "Choose A" : "Choose B";
  });
}
function current(){ return WORDS[state.i]; }

/* meters */
function renderMeter(container, n){
  container.innerHTML="";
  for(let i=0;i<n;i++){
    const d=document.createElement("div");
    d.className="pulse";
    container.appendChild(d);
  }
}
function setMeterClass(container, idx0, cls){
  const pulses=[...container.querySelectorAll(".pulse")];
  pulses.forEach((p,i)=>p.classList.toggle(cls, i===idx0));
}
function clearOn(container){
  const pulses=[...container.querySelectorAll(".pulse")];
  pulses.forEach(p=>p.classList.remove("on"));
}
let patternTimer=null;
function playPattern(container, n, stress0){
  if(patternTimer){ clearTimeout(patternTimer); patternTimer=null; }
  const bpm = Number($("#tempo").value)||108;
  const ms = Math.round(60000 / bpm);
  const loops=2;
  let step=0;
  function tick(){
    const idx = step % n;
    clickSound(idx===stress0);
    const pulses=[...container.querySelectorAll(".pulse")];
    pulses.forEach((p,i)=>p.classList.toggle("on", i===idx));
    step++;
    if(step < n*loops){
      patternTimer=setTimeout(tick, ms);
    } else {
      patternTimer=setTimeout(()=>clearOn(container), ms);
    }
  }
  tick();
}

/* PRACTICE */
function renderPractice(){
  const item=current();
  $("#titleBig").textContent=item.word;
  $("#taskHint").textContent = state.variant==="supported"
    ? "Support: tap the chunk that sounds strongest. Try Speak → Speak syllables → Tap."
    : "Tap the stressed syllable.";

  const box=$("#syllables"); box.innerHTML="";
  item.syll.forEach((s,idx)=>{
    const b=document.createElement("button");
    b.type="button";
    b.className="syll";
    b.innerHTML=`<span class="tag">syll ${idx+1}</span><span>${esc(s)}</span>`;
    b.addEventListener("click",()=>pick(idx));
    box.appendChild(b);
  });

  renderMeter($("#meterPractice"), item.syll.length);
  if(state.locked) setMeterClass($("#meterPractice"), item.stress, "acc");

  const note=$("#supportNote");
  if(state.variant==="supported"){
    note.style.display="block";
    note.innerHTML = `<b>Support tip:</b> ${esc(item.note)}<br><span style="color:rgba(238,242,255,.72)">Count left → right: #1, #2, #3…</span>`;
  } else note.style.display="none";
}
function pick(idx){
  if(state.mode!=="practice" || state.locked) return;
  state.selected=idx;
  const nodes=[...$("#syllables").querySelectorAll(".syll")];
  nodes.forEach((n,i)=>{
    n.classList.remove("sel","ok","no");
    if(i===idx) n.classList.add("sel");
  });

  if(state.variant==="supported") speak(current().syll[idx], 0.92);

  if(idx===current().stress){
    state.locked=true;
    nodes[idx].classList.add("ok");
    $("#status").innerHTML=`<span class="okText">locked ✅</span> — stress is syllable #${current().stress+1}`;
    successSound();
    state.score++; $("#score").textContent=String(state.score);
    setMeterClass($("#meterPractice"), current().stress, "acc");
  } else {
    nodes[idx].classList.add("no");
    $("#status").innerHTML=`<span class="noText">not yet</span> — try another syllable`;
  }
}

/* REMIX */
function newRemixRound(){
  clearLocks();
  const possible=[3,4].filter(n=> WORDS.filter(w=>w.syll.length===n).length>=2);
  const n = possible[Math.floor(Math.random()*possible.length)] || 3;
  const pool = WORDS.map((w,i)=>({w,i})).filter(x=>x.w.syll.length===n);

  let a, b;
  for(let tries=0; tries<50; tries++){
    a = pool[Math.floor(Math.random()*pool.length)].i;
    b = pool[Math.floor(Math.random()*pool.length)].i;
    if(a===b) continue;
    if(WORDS[a].stress !== WORDS[b].stress) break;
  }
  if(a===b){ a=pool[0].i; b=pool[1].i; }

  state.remix.a=a; state.remix.b=b; state.remix.n=n;
  state.remix.correct = Math.random()<0.5 ? "A" : "B";
  const cItem = WORDS[state.remix.correct==="A"?a:b];
  state.remix.target = cItem.stress + 1;

  renderRemix();
}
function renderRemix(){
  $("#titleBig").textContent="DJ Remix Round";
  $("#taskHint").textContent = state.variant==="supported"
    ? "Support: preview A and B. One matches the target stress position. Choose A or B."
    : "Preview A and B. Which matches the target stress position?";
  $("#targetN").textContent=String(state.remix.target);

  renderMeter($("#meterTarget"), state.remix.n);
  setMeterClass($("#meterTarget"), state.remix.target-1, "tgt");

  renderMeter($("#meterA"), state.remix.n);
  renderMeter($("#meterB"), state.remix.n);

  const aItem=WORDS[state.remix.a];
  const bItem=WORDS[state.remix.b];

  $("#aText").innerHTML = `<b>${esc(aItem.word)}</b>`;
  $("#bText").innerHTML = `<b>${esc(bItem.word)}</b>`;

  const aBox=$("#aSyll"), bBox=$("#bSyll");
  aBox.innerHTML=""; bBox.innerHTML="";
  if(state.variant==="supported"){
    aItem.syll.forEach((s,idx)=>{
      const chip=document.createElement("div");
      chip.className="syll";
      chip.style.cursor="default";
      chip.innerHTML=`<span class="tag">syll ${idx+1}</span><span>${esc(s)}</span>`;
      aBox.appendChild(chip);
    });
    bItem.syll.forEach((s,idx)=>{
      const chip=document.createElement("div");
      chip.className="syll";
      chip.style.cursor="default";
      chip.innerHTML=`<span class="tag">syll ${idx+1}</span><span>${esc(s)}</span>`;
      bBox.appendChild(chip);
    });
    $("#remixSupport").style.display="block";
    $("#remixSupport").innerHTML = `<b>Support tip:</b> Target means “the strongest syllable is #${state.remix.target}.” Preview both, then choose.`;
  } else {
    aBox.innerHTML=`<div class="hint">Syllables: ${aItem.syll.length}</div>`;
    bBox.innerHTML=`<div class="hint">Syllables: ${bItem.syll.length}</div>`;
    $("#remixSupport").style.display="none";
  }
}
async function previewA(){
  if(state.mode!=="remix") return;
  try{ await getCtx().resume(); }catch{}
  const aItem=WORDS[state.remix.a];
  playPattern($("#meterA"), state.remix.n, aItem.stress);
}
async function previewB(){
  if(state.mode!=="remix") return;
  try{ await getCtx().resume(); }catch{}
  const bItem=WORDS[state.remix.b];
  playPattern($("#meterB"), state.remix.n, bItem.stress);
}
function choose(letter){
  if(state.mode!=="remix" || state.remix.locked) return;
  state.remix.locked=true;
  const correct=state.remix.correct;
  const btnA=$("#chooseA"), btnB=$("#chooseB");
  if(letter===correct){
    $("#remixStatus").innerHTML=`<span class="okText">correct ✅</span> — stress is syllable #${state.remix.target}`;
    successSound();
    state.score++; $("#score").textContent=String(state.score);
    (letter==="A"?btnA:btnB).classList.add("good");
    (letter==="A"?btnA:btnB).textContent="Correct ✅";
    (letter==="A"?btnB:btnA).classList.add("bad");
    (letter==="A"?btnB:btnA).textContent="Not this one";
  } else {
    $("#remixStatus").innerHTML=`<span class="noText">not this time</span> — correct was ${correct}`;
    (letter==="A"?btnA:btnB).classList.add("bad");
    (letter==="A"?btnA:btnB).textContent="Not this one";
    (letter==="A"?btnB:btnA).classList.add("good");
    (letter==="A"?btnB:btnA).textContent="Correct ✅";
  }
  setMeterClass($("#meterA"), WORDS[state.remix.a].stress, "acc");
  setMeterClass($("#meterB"), WORDS[state.remix.b].stress, "acc");
}

/* Teacher key */
function renderKey(){
  const rows = WORDS.map((w,i)=>{
    const s = w.syll.map((x,idx)=> idx===w.stress ? `<b>${esc(x)}</b>` : esc(x)).join(" · ");
    return `<tr><td>${i+1}</td><td><b>${esc(w.word)}</b></td><td>${s}</td><td>${w.stress+1}</td></tr>`;
  }).join("");
  $("#key").innerHTML = `<table><thead><tr><th>#</th><th>Word</th><th>Syllables (stress bold)</th><th>Stress #</th></tr></thead><tbody>${rows}</tbody></table>`;
}

/* Global */
function next(){
  clearLocks();
  if(state.mode==="practice"){
    state.i=(state.i+1)%WORDS.length;
  } else {
    newRemixRound();
  }
  render();
}
function showAnswer(){
  if(state.mode==="practice"){
    if(!state.locked) pick(current().stress);
  } else {
    if(state.remix.locked) return;
    state.remix.locked=true;
    const correct=state.remix.correct;
    $("#remixStatus").innerHTML=`<span class="warnText">revealed</span> — correct is ${correct}`;
    const btnA=$("#chooseA"), btnB=$("#chooseB");
    (correct==="A"?btnA:btnB).classList.add("good");
    (correct==="A"?btnA:btnB).textContent="Correct ✅";
    (correct==="A"?btnB:btnA).classList.add("bad");
    (correct==="A"?btnB:btnA).textContent="Not this one";
    setMeterClass($("#meterA"), WORDS[state.remix.a].stress, "acc");
    setMeterClass($("#meterB"), WORDS[state.remix.b].stress, "acc");
  }
}
function speakCurrent(){
  if(state.mode==="practice"){
    speak(current().word, 0.95);
  } else {
    const rate = state.variant==="supported" ? 0.88 : 0.95;
    const a=WORDS[state.remix.a], b=WORDS[state.remix.b];
    speak("Option A. " + a.word + ". Option B. " + b.word, rate);
  }
}
function speakSyllsCurrent(){
  if(state.mode==="practice") speakSyllables(current());
  else {
    (async ()=>{
      await speakSyllables(WORDS[state.remix.a]);
      await new Promise(r=>setTimeout(r, 220));
      await speakSyllables(WORDS[state.remix.b]);
    })();
  }
}
function render(){
  $("#tempoText").textContent=String($("#tempo").value||108);
  renderKey();
  if(state.mode==="practice") renderPractice();
  else renderRemix();
}

/* wiring */
$("#variant").addEventListener("change",(e)=>setVariant(e.target.value));
$("#mode").addEventListener("change",(e)=>setMode(e.target.value));
$("#nextTop").addEventListener("click", next);
$("#clear").addEventListener("click", ()=>{ clearLocks(); render(); });
$("#showAnswer").addEventListener("click", showAnswer);
$("#speakWord").addEventListener("click", speakCurrent);
$("#speakSylls").addEventListener("click", speakSyllsCurrent);
$("#prevA").addEventListener("click", previewA);
$("#prevB").addEventListener("click", previewB);
$("#chooseA").addEventListener("click", ()=>choose("A"));
$("#chooseB").addEventListener("click", ()=>choose("B"));

$("#tempo").addEventListener("input",()=>{
  $("#tempoText").textContent=String($("#tempo").value||108);
  if(metroTimer){ stopMetro(); startMetro(); }
});
$("#toggleMetro").addEventListener("click", async ()=>{
  try{ await getCtx().resume(); }catch{}
  if(metroTimer) stopMetro(); else startMetro();
});
$("#reduceMotion").addEventListener("click",()=>{
  const on = !document.body.classList.contains("reduceMotion");
  document.body.classList.toggle("reduceMotion", on);
  $("#reduceMotion").textContent = on ? "Motion reduced" : "Reduce motion";
});

document.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){ speakCurrent(); return; }
  if(state.mode==="practice"){
    if(e.key>="1" && e.key<="9"){
      const idx=parseInt(e.key,10)-1;
      if(idx < current().syll.length) pick(idx);
    }
    if(e.key==="ArrowRight") next();
  } else {
    if(e.key==="a"||e.key==="A") choose("A");
    if(e.key==="b"||e.key==="B") choose("B");
    if(e.key==="p"||e.key==="P") previewA();
    if(e.key==="o"||e.key==="O") previewB();
    if(e.key==="ArrowRight") next();
  }
});

refreshVoices();
if(window.speechSynthesis) speechSynthesis.onvoiceschanged = refreshVoices;

setMode("practice");
render();
</script>
<!-- WORDINESS_FAILSAFE_PATCH v1 -->
<script id="wordiness-failsafe-patch">
(function(){
  if (window.__wordinessFailsafePatch) return;
  window.__wordinessFailsafePatch = true;

  const VOWEL = /[aeiouy]/i;

  const EXCEPTIONS = {
    different:   { spelling:["dif","fer","ent"], spoken:[["dif","frent"],["dif","rent"]] },
    vegetable:   { spelling:["ve","ge","ta","ble"], spoken:[["veg","ta","ble"],["vej","ta","bul"]] },
    factory:     { spelling:["fac","to","ry"], spoken:[["fac","tuh","ree"],["fac","tri"]] },
    family:      { spelling:["fam","i","ly"], spoken:[["fam","ly"]] },
    chocolate:   { spelling:["choc","o","late"], spoken:[["choc","late"]] },
    camera:      { spelling:["cam","er","a"], spoken:[["cam","ra"]] },
    interesting: { spelling:["in","ter","est","ing"], spoken:[["in","tres","ting"]] },
    probably:    { spelling:["prob","a","bly"], spoken:[["prob","ly"]] }
  };

  function hasVowelLetters(s){ return VOWEL.test(String(s||"")); }
  function lettersSpaced(s){ return String(s||"").split("").join(" "); }
  function onlyLetters(s){ return String(s||"").toLowerCase().replace(/[^a-z']/g,""); }

  function normalizeLine(s){
    return String(s||"")
      .replace(/[\u2010\u2011\u2012\u2013\u2014\u2212]/g, "-") // fancy dashes
      .replace(/\u00B7/g, "·") // middle dot
      .trim();
  }

  // Extract sensible words from pasted text, but preserve already-marked syllable lines
  function sanitizeSeedText(raw){
    raw = String(raw||"").replace(/\r/g,"");
    const out = [];
    for (const line0 of raw.split("\n")) {
      const line = normalizeLine(line0);
      if (!line) continue;

      // Keep marked syllable lines like dif-fer-ent (no spaces)
      if (/[-·]/.test(line) && !/\s/.test(line)) {
        out.push(line);
        continue;
      }

      // Otherwise extract word tokens from the line
      const toks = line.match(/[A-Za-z]+(?:'[A-Za-z]+)?/g);
      if (!toks) continue;
      for (const w of toks) {
        if (w.length > 28) continue;
        if (!hasVowelLetters(w)) continue;
        out.push(w);
      }
    }

    // de-dupe, preserve order
    const seen = new Set();
    const final = [];
    for (const w of out) {
      const k = w.toLowerCase();
      if (seen.has(k)) continue;
      seen.add(k);
      final.push(w);
    }
    return final.join("\n");
  }

  // Replace a specific line (by index) with chunked form, joined by '-'
  function replaceLine(text, lineIndex, newChunks){
    const lines = String(text||"").replace(/\r/g,"").split("\n");
    if (lineIndex < 0 || lineIndex >= lines.length) return text;
    lines[lineIndex] = newChunks.join("-");
    return lines.join("\n");
  }

  // Find a textarea likely used for word lists
  function findSeedTextarea(){
    return document.querySelector("textarea#input, textarea#seed, textarea[data-seed], textarea");
  }

  // Build helper UI under textarea: reduction suggestions + failsafe warnings + sanitize button
  function attachHelperUI(ta){
    if (!ta || ta.__wordinessHelperAttached) return;
    ta.__wordinessHelperAttached = true;

    const host = document.createElement("div");
    host.style.cssText = [
      "margin-top:10px",
      "border:1px solid rgba(255,255,255,.14)",
      "border-radius:14px",
      "padding:10px 12px",
      "background:rgba(0,0,0,.10)",
      "color:rgba(238,242,255,.85)",
      "font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial",
      "font-size:13px"
    ].join(";");

    const hdr = document.createElement("div");
    hdr.style.cssText = "display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;";
    hdr.innerHTML = `<b>Wordiness helpers</b>
      <span style="opacity:.8">failsafes + disappearing-vowel options</span>`;
    host.appendChild(hdr);

    const btnRow = document.createElement("div");
    btnRow.style.cssText = "display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;";
    const sanitizeBtn = document.createElement("button");
    sanitizeBtn.type = "button";
    sanitizeBtn.textContent = "Sanitize pasted text → words";
    sanitizeBtn.style.cssText =
      "cursor:pointer;border-radius:999px;padding:8px 10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);color:rgba(238,242,255,.92);font-weight:700;";
    btnRow.appendChild(sanitizeBtn);
    host.appendChild(btnRow);

    const msg = document.createElement("div");
    msg.style.cssText = "margin-top:10px;opacity:.9;";
    host.appendChild(msg);

    const sug = document.createElement("div");
    sug.style.cssText = "display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;";
    host.appendChild(sug);

    function refresh(){
      const raw = String(ta.value||"");
      const lines = raw.replace(/\r/g,"").split("\n").map(normalizeLine);
      sug.innerHTML = "";

      // Warnings: chunks with no vowel letters (only checks marked chunk lines)
      let warnCount = 0;
      for (const ln of lines) {
        if (!ln) continue;
        if (/[-·]/.test(ln) && !/\s/.test(ln)) {
          const parts = ln.split(/[-·]+/).map(s=>s.trim()).filter(Boolean);
          const bad = parts.filter(p=>!hasVowelLetters(p));
          if (bad.length) warnCount++;
        }
      }

      // Suggestions for disappearing vowels
      const found = [];
      lines.forEach((ln, i)=>{
        if (!ln) return;
        const key = onlyLetters(ln.replace(/[-·]/g,""));
        if (EXCEPTIONS[key]) found.push({ key, i });
      });

      msg.innerHTML =
        `${warnCount ? `<span style="color:#f59e0b;font-weight:800">${warnCount} warning(s)</span> (chunk has no vowel letters). ` : `<span style="color:#22c55e;font-weight:800">No failsafe warnings</span>. `}
         ${found.length ? `Found <b>${found.length}</b> reduction word(s).` : `No reduction words detected in list.`}`;

      // Make buttons for each found word
      found.slice(0, 12).forEach(({key, i})=>{
        const ex = EXCEPTIONS[key];
        const label = key;
        const makeBtn = (text, chunks) => {
          const b = document.createElement("button");
          b.type = "button";
          b.textContent = `${label}: ${text}`;
          b.style.cssText =
            "cursor:pointer;border-radius:999px;padding:8px 10px;border:1px solid rgba(56,189,248,.28);background:rgba(56,189,248,.08);color:rgba(238,242,255,.92);font-weight:800;";
          b.onclick = ()=>{
            ta.value = replaceLine(ta.value, i, chunks);
            ta.dispatchEvent(new Event("input", { bubbles:true }));
          };
          return b;
        };

        if (ex.spelling) sug.appendChild(makeBtn("Use spelling", ex.spelling));
        if (Array.isArray(ex.spoken)) {
          ex.spoken.forEach(opt => sug.appendChild(makeBtn("Use spoken", opt)));
        }
      });
    }

    sanitizeBtn.onclick = ()=>{
      const before = ta.value;
      const after = sanitizeSeedText(before);
      if (after && after !== before) {
        ta.value = after;
        ta.dispatchEvent(new Event("input", { bubbles:true }));
      }
    };

    // Insert right after textarea
    ta.insertAdjacentElement("afterend", host);

    // Live update
    let t = null;
    ta.addEventListener("input", ()=>{
      clearTimeout(t);
      t = setTimeout(refresh, 120);
    });
    refresh();
  }

  // TTS fail-safe wrapper: if no vowel letters and short, speak letters spaced
  function wrapSpeak(fnName){
    const old = window[fnName];
    if (typeof old !== "function") return;
    if (old.__wordinessWrapped) return;

    function wrapped(text, ...rest){
      const t = String(text||"").trim();
      if (t && !hasVowelLetters(t) && t.length <= 8) {
        return old.call(this, lettersSpaced(t), ...rest);
      }
      return old.call(this, text, ...rest);
    }
    wrapped.__wordinessWrapped = true;
    window[fnName] = wrapped;
  }

  // Try common TTS function names used across your games
  ["speakNow","speak","speakText","say"].forEach(wrapSpeak);

  // Seed sanitiser if game uses #seed=
  function patchSeedFromHash(){
    const h = String(location.hash||"");
    if (!/seed=/.test(h)) return;
    const ta = findSeedTextarea();
    if (!ta) return;
    const before = ta.value;
    const after = sanitizeSeedText(before);
    if (after && after !== before) {
      ta.value = after;
      ta.dispatchEvent(new Event("input", { bubbles:true }));
    }
  }

  // Attach helpers on load
  function boot(){
    const ta = findSeedTextarea();
    if (ta) attachHelperUI(ta);
    patchSeedFromHash();
  }

  window.addEventListener("hashchange", ()=>setTimeout(patchSeedFromHash, 0));
  setTimeout(boot, 80);

})();
</script>
<!-- /WORDINESS_FAILSAFE_PATCH v1 -->
<script>
// wordiness-touch-helpers-v4
(function(){
  try{
    var isCoarse=false;
    try{ isCoarse = window.matchMedia && window.matchMedia("(pointer: coarse)").matches; }catch(e){}
    var isTouch = isCoarse || ("ontouchstart" in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints>0);

    // Crest fallback (works for /wordiness and file:// exports)
    var crest = document.getElementById("crest");
    if (crest && crest.tagName === "IMG") {
      crest.addEventListener("error", function(){ crest.src="/wordiness/crest.png"; }, { once:true });
    }

    if(!isTouch) return;

    var drags = Array.prototype.slice.call(document.querySelectorAll('[draggable="true"]'));
    if(!drags.length) return;

    drags.forEach(function(el){
      el.classList.add("wordiness-draggable");
      el.addEventListener("click", function(){
        drags.forEach(function(x){ x.classList.remove("wordiness-drag-selected"); });
        el.classList.add("wordiness-drag-selected");
      }, { passive:true });
    });

    var btn = document.createElement("button");
    btn.id="wordinessTouchToggle";
    btn.type="button";
    btn.style.position="fixed";
    btn.style.right="12px";
    btn.style.bottom="calc(12px + env(safe-area-inset-bottom, 0px))";
    btn.style.zIndex="9999";
    btn.style.border="1px solid rgba(255,255,255,.18)";
    btn.style.background="rgba(0,0,0,.45)";
    btn.style.color="rgba(238,242,255,.95)";
    btn.style.backdropFilter="blur(10px)";
    btn.style.borderRadius="999px";
    btn.style.padding="10px 12px";
    btn.style.font="600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    btn.style.touchAction="manipulation";

    var dragEnabled=true;
    function applyState(){
      drags.forEach(function(el){ el.setAttribute("draggable", dragEnabled ? "true" : "false"); });
      btn.textContent = dragEnabled ? "Touch: Drag ON" : "Touch: Drag OFF";
    }
    btn.addEventListener("click", function(){ dragEnabled=!dragEnabled; applyState(); });

    document.body.appendChild(btn);
    applyState();
  }catch(e){}
})();
</script>

<!-- wordiness-seed-bridge-v1 -->
<script src="wordiness-seed-bridge.js"></script>
</body>
</html>
